// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Seed configuration

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          Int      @id @default(autoincrement())
  name        String
  email       String   @unique
  passwordHash String  @map("password_hash")
  phone       String?
  role        String   @default("customer") // "customer", "admin", or "provider"
  registered  String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  customerProfile CustomerProfile?
  adminProfile    AdminProfile?

  @@map("users")
}

model Booking {
  id        Int      @id @default(autoincrement())
  name      String
  address   String
  date      String
  time      String
  service   String
  details   String?
  status    String   @default("pending")
  amount    Float    @default(0.0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("bookings")
}

model Complaint {
  id                Int       @id @default(autoincrement())
  name              String
  email             String?
  type              String
  title             String
  description       String
  status            String    @default("pending")
  date              String
  serviceProvider    String?   @map("service_provider")
  desiredResolution String?   @map("desired_resolution")
  contactPreference String?   @map("contact_preference")
  urgencyLevel      String?   @map("urgency_level")
  serviceDate       String?   @map("service_date")
  isAnonymous      Boolean   @default(false) @map("is_anonymous")
  followUpEnabled   Boolean   @default(true) @map("follow_up_enabled")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("complaints")
}

model ServiceProvider {
  id              Int      @id @default(autoincrement())
  name            String
  serviceType     String   @map("service_type")
  phone           String
  email           String   @unique
  address         String?
  experienceYears Int      @default(0) @map("experience_years")
  hourlyRate      Float    @default(0.0) @map("hourly_rate")
  rating          Float    @default(0.0)
  totalBookings   Int      @default(0) @map("total_bookings")
  status          String   @default("active")
  registered      String
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  serviceRequests ServiceRequest[]
  trustScore      TrustScore?
  providerProfile ProviderProfile?
  reviews         Review[]
  disputes        Dispute[]
  payments        Payment[]

  @@map("service_providers")
}

model ServicePricing {
  id                    Int      @id @default(autoincrement())
  serviceCategory       String   @map("service_category")
  serviceType           String   @map("service_type")
  itemDescription       String?  @map("item_description")
  providerBasePrice     Float    @map("provider_base_price")
  customerDisplayPrice  Float    @map("customer_display_price")
  colorSurchargeProvider Float   @default(0) @map("color_surcharge_provider")
  colorSurchargeCustomer Float   @default(0) @map("color_surcharge_customer")
  isWhiteApplicable     Boolean  @default(false) @map("is_white_applicable")
  commissionPercentage  Float    @default(10) @map("commission_percentage")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("service_pricing")
}

model Customer {
  customerId     Int      @id @default(autoincrement()) @map("customer_id")
  customerName   String   @map("customer_name")
  customerEmail  String   @map("customer_email")
  customerPhone  String   @map("customer_phone")
  savedAddresses String? @map("saved_addresses")
  totalBookings  Int      @default(0) @map("total_bookings")
  createdAt      DateTime @default(now()) @map("created_at")

  serviceRequests ServiceRequest[]
  reviews        Review[]
  disputes       Dispute[]
  payments       Payment[]

  @@map("customers")
}

model ServiceRequest {
  requestId              Int       @id @default(autoincrement()) @map("request_id")
  customerId             Int?      @map("customer_id")
  customerName           String    @map("customer_name")
  customerEmail          String    @map("customer_email")
  customerPhone          String    @map("customer_phone")
  customerAddress        String    @map("customer_address")
  unitNumber             String?   @map("unit_number")
  complexName            String?   @map("complex_name")
  accessInstructions     String?   @map("access_instructions")
  preferredDate          DateTime  @map("preferred_date")
  preferredTime          String    @map("preferred_time")
  additionalNotes        String?   @map("additional_notes")
  selectedItems          String?   @map("selected_items")
  totalCustomerPaid      Float?    @map("total_customer_paid")
  totalProviderPayout    Float?    @map("total_provider_payout")
  totalCommissionEarned  Float?    @map("total_commission_earned")
  status                 String    @default("pending") // pending, broadcasted, interested, assigned, in_progress, completed, cancelled
  priority               String    @default("medium")
  assignedProviderId     Int?      @map("assigned_provider_id")
  providerName           String?   @map("provider_name")
  providerPhone          String?   @map("provider_phone")
  providerEmail          String?   @map("provider_email")
  interestedProviders    String?   @map("interested_providers") // JSON array: [{providerId, providerName, acceptedAt, rating}]
  assignedAt             DateTime? @map("assigned_at")
  assignedBy             String?   @map("assigned_by") // admin email who assigned
  paymentMethod          String?   @map("payment_method")
  proofOfPaymentUrl     String?   @map("proof_of_payment_url")
  customerPaymentReceived Boolean  @default(false) @map("customer_payment_received")
  providerPaymentMade    Boolean  @default(false) @map("provider_payment_made")
  commissionCollected     Boolean  @default(false) @map("commission_collected")
  customerConfirmedCompletion Boolean @default(false) @map("customer_confirmed_completion")
  providerConfirmedCompletion Boolean @default(false) @map("provider_confirmed_completion")
  adminNotes             String?   @map("admin_notes")
  auditLog               String?   @map("audit_log") // JSON array: [{action, userId, timestamp, details}]
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  confirmedAt            DateTime? @map("confirmed_at")
  completedAt            DateTime? @map("completed_at")
  reminderSentAt         DateTime? @map("reminder_sent_at")

  customer  Customer?         @relation(fields: [customerId], references: [customerId])
  provider  ServiceProvider?  @relation(fields: [assignedProviderId], references: [id])

  @@map("service_requests")
}

// Trust Score Model - Computed signal for providers
model TrustScore {
  id                Int       @id @default(autoincrement())
  providerId        Int       @unique @map("provider_id")
  reliabilityScore   Float     @default(0.0) @map("reliability_score") // 0-100
  completionRate     Float     @default(0.0) @map("completion_rate") // 0-1
  cancellationRate   Float     @default(0.0) @map("cancellation_rate") // 0-1
  averageRating      Float     @default(0.0) @map("average_rating") // 0-5
  verificationLevel  Int       @default(0) @map("verification_level") // 0-3
  trustScore         Float     @default(0.0) @map("trust_score") // 0-100 (computed)
  totalJobs          Int       @default(0) @map("total_jobs")
  completedJobs      Int       @default(0) @map("completed_jobs")
  cancelledJobs      Int       @default(0) @map("cancelled_jobs")
  totalReviews       Int       @default(0) @map("total_reviews")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  provider ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("trust_scores")
}

// Review Model - Mutual reviews between customers and providers
model Review {
  id              Int       @id @default(autoincrement())
  jobId            Int       @map("job_id") // ServiceRequest.requestId
  customerId       Int       @map("customer_id")
  providerId       Int       @map("provider_id")
  reviewedBy       String    @map("reviewed_by") // "customer" or "provider"
  reviewedUserId   Int       @map("reviewed_user_id") // ID of the user being reviewed (customer or provider)
  rating           Int       // 1-5
  comment          String?
  reliabilityScore Float?    @map("reliability_score") // 0-100
  qualityScore     Float?    @map("quality_score") // 0-100
  communicationScore Float?  @map("communication_score") // 0-100
  isVerified       Boolean   @default(false) @map("is_verified")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [customerId])
  provider ServiceProvider @relation(fields: [providerId], references: [id])

  @@unique([jobId, reviewedBy]) // One review per job per reviewer (customer or provider)
  @@map("reviews")
}

// Dispute Model - Formal disputes between customers and providers
model Dispute {
  id                Int       @id @default(autoincrement())
  jobId              Int       @map("job_id") // ServiceRequest.requestId
  customerId         Int       @map("customer_id")
  providerId         Int       @map("provider_id")
  initiatedBy        String    @map("initiated_by") // "customer" or "provider"
  reason             String
  description        String
  status             String    @default("pending") // pending, in_review, resolved, dismissed
  resolution         String?
  resolvedBy         String?   @map("resolved_by") // admin email
  resolvedAt         DateTime? @map("resolved_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [customerId])
  provider ServiceProvider @relation(fields: [providerId], references: [id])

  @@map("disputes")
}

// Payment Model - Separate payment tracking (escrow system)
model Payment {
  id                    Int       @id @default(autoincrement())
  jobId                 Int       @map("job_id") // ServiceRequest.requestId
  customerId            Int       @map("customer_id")
  providerId            Int?      @map("provider_id")
  amount                Float     // Total amount paid by customer
  providerPayout        Float?    @map("provider_payout") // Amount to provider
  commission            Float?    // HomeSwift commission
  paymentMethod         String    @map("payment_method") // eft, credit_card, etc.
  status                String    @default("pending") // pending, in_escrow, released, refunded
  customerPaidAt        DateTime? @map("customer_paid_at")
  releasedAt            DateTime? @map("released_at")
  releasedBy            String?   @map("released_by") // admin email or system
  proofOfPaymentUrl     String?   @map("proof_of_payment_url")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [customerId])
  provider ServiceProvider? @relation(fields: [providerId], references: [id])

  @@map("payments")
}

// Service Model - Available services catalog
model Service {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  category        String    // e.g., "cleaning", "maintenance", "repair"
  description     String?
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("services")
}

// Customer Profile Model - Extended customer information
model CustomerProfile {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique @map("user_id")
  address         String?
  city            String?
  postalCode      String?   @map("postal_code")
  preferredContactMethod String? @map("preferred_contact_method")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("customer_profiles")
}

// Provider Profile Model - Extended provider information
model ProviderProfile {
  id              Int       @id @default(autoincrement())
  providerId      Int       @unique @map("provider_id")
  bankName        String?   @map("bank_name")
  bankAccountNumber String? @map("bank_account_number")
  bankAccountType String?   @map("bank_account_type")
  idNumber        String?   @map("id_number")
  taxNumber       String?   @map("tax_number")
  businessRegistration String? @map("business_registration")
  verificationStatus String  @default("pending") @map("verification_status") // pending, verified, rejected
  verifiedAt      DateTime? @map("verified_at")
  verifiedBy      String?   @map("verified_by") // admin email
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  provider ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_profiles")
}

// Admin Profile Model - Extended admin information
model AdminProfile {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique @map("user_id")
  department      String?
  permissions     String? // JSON array of permissions
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admin_profiles")
}

// Audit Log Model - Centralized audit logging
model AuditLog {
  id              Int       @id @default(autoincrement())
  action          String    // e.g., "user_login", "job_created", "provider_assigned"
  userId          Int?      @map("user_id")
  userEmail       String?   @map("user_email")
  userRole        String?   @map("user_role")
  resourceType    String    @map("resource_type") // e.g., "user", "job", "payment"
  resourceId      Int?      @map("resource_id")
  details         String? // JSON string
  ipAddress       String?   @map("ip_address")
  userAgent       String?   @map("user_agent")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}