<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>HomeSwift | Request a Service</title>
    <meta name="theme-color" content="#3b82f6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#3b82f6",
              secondary: "#64748b",
              accent: "#f59e0b",
              success: "#10b981",
              danger: "#ef4444",
              warning: "#f59e0b",
              info: "#3b82f6",
              light: "#f8fafc",
              dark: "#1e293b",
            },
          },
        },
      };
    </script>
    <style>
      .sticky-summary {
        position: sticky;
        top: 20px;
      }
      @media (max-width: 768px) {
        .sticky-summary {
          position: relative;
          top: 0;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- Back Button -->
    <a href="../../index.html" class="fixed top-4 left-4 z-50 bg-white hover:bg-gray-100 text-gray-700 font-bold py-2 px-3 rounded-full shadow-lg transition-colors duration-200">
      &lt;
    </a>

    <!-- Header -->
    <header class="bg-blue-900 text-white py-8 px-4 shadow-lg">
      <div class="max-w-6xl mx-auto text-center">
        <h1 class="text-3xl md:text-4xl font-bold mb-2">Request a Service</h1>
        <p class="text-lg text-blue-100">Book your cleaning service with transparent pricing</p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Form Section -->
        <div class="lg:col-span-2">
          <form id="booking-form" class="space-y-8">
            <!-- SECTION 1: Service Selection -->
            <section class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-2xl font-bold mb-6 text-gray-800">Service Selection</h2>
              
              <div id="items-container" class="space-y-6">
                <!-- Item Template -->
                <div class="item-row border border-gray-200 rounded-lg p-4 bg-gray-50">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Service Category *</label>
                      <select name="category" class="category-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <option value="">Select Category</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Service Type *</label>
                      <select name="type" class="type-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required disabled>
                        <option value="">Select Category First</option>
                      </select>
                    </div>
                  </div>
                  
                  <div id="white-checkbox-container" class="mb-4 hidden">
                    <label class="flex items-center space-x-2 cursor-pointer">
                      <input type="checkbox" name="is_white" class="white-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <span class="text-sm font-medium text-gray-700 white-checkbox-label"></span>
                    </label>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
                      <input type="number" name="quantity" min="1" max="10" value="1" class="quantity-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    <div class="flex items-end">
                      <button type="button" class="remove-item-btn hidden text-red-600 hover:text-red-800 font-medium text-sm">Remove Item</button>
                    </div>
                  </div>
                </div>
              </div>
              
              <button type="button" id="add-item-btn" class="mt-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                + Add Another Item
              </button>
            </section>

            <!-- SECTION 2: Schedule Details -->
            <section class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-2xl font-bold mb-6 text-gray-800">Schedule Details</h2>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Date *</label>
                  <input type="date" name="preferred_date" id="preferred_date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Time *</label>
                  <select name="preferred_time" id="preferred_time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    <option value="">Select Time</option>
                  </select>
                </div>
              </div>
            </section>

            <!-- SECTION 3: Location Details -->
            <section class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-2xl font-bold mb-6 text-gray-800">Location Details</h2>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Full Address *</label>
                  <textarea name="customer_address" rows="3" placeholder="Street address, suburb, city, postal code" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unit/Apartment Number</label>
                    <input type="text" name="unit_number" placeholder="e.g., Unit 5B" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Complex/Building Name</label>
                    <input type="text" name="complex_name" placeholder="e.g., Sandton Heights" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Access Instructions</label>
                  <textarea name="access_instructions" rows="2" placeholder="Gate code, parking info, special instructions" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
              </div>
            </section>

            <!-- SECTION 4: Contact Details -->
            <section class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-2xl font-bold mb-6 text-gray-800">Contact Details</h2>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                  <input type="text" name="customer_name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                    <input type="tel" name="customer_phone" placeholder="0#########" maxlength="10" pattern="[0-9]{10}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    <p class="text-xs text-gray-500 mt-1">10 digits (South African format)</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                    <input type="email" name="customer_email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                  <textarea name="additional_notes" rows="3" placeholder="Any special requests or details we should know?" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
              </div>
            </section>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition-colors shadow-lg">
              Confirm Booking
            </button>
          </form>
        </div>

        <!-- Booking Summary (Sticky) -->
        <div class="lg:col-span-1">
          <div class="sticky-summary bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">YOUR BOOKING</h2>
            <div class="border-t border-b border-gray-200 py-4 mb-4">
              <div id="booking-items-list" class="space-y-2 text-sm">
                <p class="text-gray-500">Add items to see your booking summary</p>
              </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
              <div id="subtotal-section" class="mb-2" style="display: none;">
                <div class="flex justify-between items-center text-sm text-gray-600 mb-1">
                  <span>Subtotal:</span>
                  <span id="subtotal-price">R0.00</span>
                </div>
                <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
                  <span>Callout Fee:</span>
                  <span>R100.00</span>
                </div>
              </div>
              <div class="flex justify-between items-center mb-2 border-t border-gray-200 pt-2">
                <span class="text-lg font-bold text-gray-800">TOTAL:</span>
                <span id="total-price" class="text-2xl font-bold text-green-600">R0.00</span>
              </div>
              <p class="text-xs text-gray-500 mb-4">All prices include service fees</p>
              <p class="text-xs text-gray-500 italic">Final price confirmed after assessment. You'll receive confirmation within 2 hours.</p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-700">Processing your booking...</p>
      </div>
    </div>

    <script src="../../js/config.js"></script>
    <script>
      // Global state
      let categories = [];
      let pricingData = {};
      let cartItems = [];
      const CALLOUT_FEE = 100; // R100 callout fee for all bookings

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        initializeTimeSlots();
        setMinDate();
        loadCategories();
        setupFormHandlers();
      });

      // Set minimum date to today
      function setMinDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('preferred_date').setAttribute('min', today);
      }

      // Initialize time slots (8:00 AM to 6:00 PM, 30-minute intervals)
      function initializeTimeSlots() {
        const timeSelect = document.getElementById('preferred_time');
        const times = [];
        for (let hour = 8; hour <= 18; hour++) {
          for (let minute = 0; minute < 60; minute += 30) {
            const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            const displayTime = formatTime(hour, minute);
            times.push({ value: timeStr, display: displayTime });
          }
        }
        times.forEach(time => {
          const option = document.createElement('option');
          option.value = time.value;
          option.textContent = time.display;
          timeSelect.appendChild(option);
        });
      }

      function formatTime(hour, minute) {
        const period = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
        return `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;
      }

      // Service categories from price list
      const SERVICE_CATEGORIES = [
        'Couch Deep Cleaning',
        'Carpet Deep Cleaning',
        'Fitted Carpet Deep Cleaning',
        'Mattress Deep Cleaning',
        'Headboard Deep Cleaning',
        'Sleigh Bed Deep Cleaning',
        'Standard Apartment Cleaning',
        'Apartment Spring Cleaning',
        'Apartment Deep Cleaning',
        'Empty Apartment Deep Cleaning',
        'House Spring Cleaning',
        'House Deep Cleaning',
        'Empty House Deep Cleaning'
      ];

      // Hardcoded pricing data as fallback
      const HARDCODED_PRICING = {
        'Couch Deep Cleaning': [
          { service_type: '1 Seater Couch', customer_display_price: 220, is_white_applicable: true, color_surcharge_customer: 220 },
          { service_type: '2 Seater Couch', customer_display_price: 440, is_white_applicable: true, color_surcharge_customer: 220 },
          { service_type: '3 Seater Couch', customer_display_price: 550, is_white_applicable: true, color_surcharge_customer: 220 },
          { service_type: '4 Seater Couch', customer_display_price: 660, is_white_applicable: true, color_surcharge_customer: 220 },
          { service_type: '5 Seater Couch', customer_display_price: 770, is_white_applicable: true, color_surcharge_customer: 220 },
          { service_type: '6 Seater Couch', customer_display_price: 880, is_white_applicable: true, color_surcharge_customer: 220 },
          { service_type: '3 Seater L Couch', customer_display_price: 660, is_white_applicable: true, color_surcharge_customer: 220 },
          { service_type: '4 Seater L Couch', customer_display_price: 770, is_white_applicable: true, color_surcharge_customer: 220 },
          { service_type: '5 Seater L Couch', customer_display_price: 880, is_white_applicable: true, color_surcharge_customer: 220 },
          { service_type: '6 Seater L Couch', customer_display_price: 990, is_white_applicable: true, color_surcharge_customer: 220 }
        ],
        'Carpet Deep Cleaning': [
          { service_type: 'Extra-Small', customer_display_price: 275, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: 'Small', customer_display_price: 330, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: 'Medium', customer_display_price: 385, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: 'Large', customer_display_price: 440, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: 'X-Large', customer_display_price: 495, is_white_applicable: false, color_surcharge_customer: 0 }
        ],
        'Fitted Carpet Deep Cleaning': [
          { service_type: 'Standard Room', customer_display_price: 495, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: 'Master Bedroom', customer_display_price: 660, is_white_applicable: false, color_surcharge_customer: 0 }
        ],
        'Mattress Deep Cleaning': [
          { service_type: 'Single', customer_display_price: 385, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: 'Double', customer_display_price: 495, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: 'Queen', customer_display_price: 550, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: 'King', customer_display_price: 605, is_white_applicable: false, color_surcharge_customer: 0 }
        ],
        'Headboard Deep Cleaning': [
          { service_type: 'Single', customer_display_price: 220, is_white_applicable: true, color_surcharge_customer: 110 },
          { service_type: 'Double', customer_display_price: 275, is_white_applicable: true, color_surcharge_customer: 110 },
          { service_type: 'Queen', customer_display_price: 330, is_white_applicable: true, color_surcharge_customer: 110 },
          { service_type: 'King', customer_display_price: 385, is_white_applicable: true, color_surcharge_customer: 110 }
        ],
        'Sleigh Bed Deep Cleaning': [
          { service_type: 'Single', customer_display_price: 330, is_white_applicable: true, color_surcharge_customer: 165 },
          { service_type: 'Double', customer_display_price: 385, is_white_applicable: true, color_surcharge_customer: 165 },
          { service_type: 'Queen', customer_display_price: 418, is_white_applicable: true, color_surcharge_customer: 165 },
          { service_type: 'King', customer_display_price: 440, is_white_applicable: true, color_surcharge_customer: 165 }
        ],
        'Standard Apartment Cleaning': [
          { service_type: 'Bachelor Apartment', customer_display_price: 330, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '1 Bedroom Apartment', customer_display_price: 385, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '2 Bedroom Apartment', customer_display_price: 440, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '3 Bedroom Apartment', customer_display_price: 495, is_white_applicable: false, color_surcharge_customer: 0 }
        ],
        'Apartment Spring Cleaning': [
          { service_type: 'Bachelor Apartment', customer_display_price: 660, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '1 Bedroom Apartment', customer_display_price: 770, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '2 Bedroom Apartment', customer_display_price: 880, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '3 Bedroom Apartment', customer_display_price: 1100, is_white_applicable: false, color_surcharge_customer: 0 }
        ],
        'Apartment Deep Cleaning': [
          { service_type: 'Bachelor Apartment', customer_display_price: 1980, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '1 Bedroom Apartment', customer_display_price: 2200, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '2 Bedroom Apartment', customer_display_price: 2750, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '3 Bedroom Apartment', customer_display_price: 3300, is_white_applicable: false, color_surcharge_customer: 0 }
        ],
        'Empty Apartment Deep Cleaning': [
          { service_type: 'Bachelor Apartment', customer_display_price: 1320, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '1 Bedroom Apartment', customer_display_price: 1430, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '2 Bedroom Apartment', customer_display_price: 1650, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '3 Bedroom Apartment', customer_display_price: 1980, is_white_applicable: false, color_surcharge_customer: 0 }
        ],
        'House Spring Cleaning': [
          { service_type: '2 Bedroom House', customer_display_price: 1980, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '3 Bedroom House', customer_display_price: 2310, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '4 Bedroom House', customer_display_price: 2750, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '5 Bedroom House', customer_display_price: 3300, is_white_applicable: false, color_surcharge_customer: 0 }
        ],
        'House Deep Cleaning': [
          { service_type: '2 Bedroom House', customer_display_price: 3960, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '3 Bedroom House', customer_display_price: 4950, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '4 Bedroom House', customer_display_price: 5940, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '5 Bedroom House', customer_display_price: 7150, is_white_applicable: false, color_surcharge_customer: 0 }
        ],
        'Empty House Deep Cleaning': [
          { service_type: '2 Bedroom House', customer_display_price: 2750, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '3 Bedroom House', customer_display_price: 3850, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '4 Bedroom House', customer_display_price: 4950, is_white_applicable: false, color_surcharge_customer: 0 },
          { service_type: '5 Bedroom House', customer_display_price: 6050, is_white_applicable: false, color_surcharge_customer: 0 }
        ]
      };

      // Load categories from API or use hardcoded list
      async function loadCategories() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/pricing/categories`);
          if (response.ok) {
            const apiCategories = await response.json();
            if (apiCategories && apiCategories.length > 0) {
              categories = apiCategories;
            } else {
              categories = SERVICE_CATEGORIES;
            }
          } else {
            categories = SERVICE_CATEGORIES;
          }
        } catch (error) {
          console.error('Error loading categories from API, using hardcoded list:', error);
          categories = SERVICE_CATEGORIES;
        }
        populateCategoryDropdowns();
      }

      // Populate category dropdowns
      function populateCategoryDropdowns() {
        document.querySelectorAll('.category-select').forEach(select => {
          const currentValue = select.value;
          select.innerHTML = '<option value="">Select Category</option>';
          categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
          if (currentValue) select.value = currentValue;
        });
      }

      // Setup form handlers
      function setupFormHandlers() {
        // Category change handler
        document.addEventListener('change', async (e) => {
          if (e.target.classList.contains('category-select')) {
            await handleCategoryChange(e.target);
          }
          if (e.target.classList.contains('type-select')) {
            handleTypeChange(e.target);
          }
          if (e.target.classList.contains('white-checkbox') || e.target.classList.contains('quantity-input')) {
            updateCart();
            updateSummary();
          }
        });

        // Add item button
        document.getElementById('add-item-btn').addEventListener('click', addItemRow);

        // Remove item buttons
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('remove-item-btn')) {
            removeItemRow(e.target.closest('.item-row'));
          }
        });

        // Form submission
        document.getElementById('booking-form').addEventListener('submit', handleSubmit);
      }

      // Handle category selection
      async function handleCategoryChange(select) {
        const category = select.value;
        const itemRow = select.closest('.item-row');
        const typeSelect = itemRow.querySelector('.type-select');
        const whiteContainer = itemRow.querySelector('#white-checkbox-container');
        
        typeSelect.innerHTML = '<option value="">Loading...</option>';
        typeSelect.disabled = true;
        whiteContainer.classList.add('hidden');

        if (!category) {
          typeSelect.innerHTML = '<option value="">Select Category First</option>';
          return;
        }

        // Try API first, then fallback to hardcoded data
        let items = null;
        try {
          const response = await fetch(`${API_BASE_URL}/api/pricing?category=${encodeURIComponent(category)}`);
          if (response.ok) {
            items = await response.json();
            if (items && items.length > 0) {
              pricingData[category] = items;
            }
          }
        } catch (error) {
          console.warn('API call failed, using hardcoded data:', error);
        }

        // Fallback to hardcoded data if API failed or returned empty
        if (!items || items.length === 0) {
          if (HARDCODED_PRICING[category]) {
            items = HARDCODED_PRICING[category].map(item => ({
              service_type: item.service_type,
              customer_display_price: item.customer_display_price,
              is_white_applicable: item.is_white_applicable,
              color_surcharge_customer: item.color_surcharge_customer,
              provider_base_price: item.customer_display_price * 0.9, // 10% commission
              color_surcharge_provider: item.color_surcharge_customer * 0.9
            }));
            pricingData[category] = items;
          } else {
            typeSelect.innerHTML = '<option value="">No options available</option>';
            return;
          }
        }
        
        // Populate dropdown
        typeSelect.innerHTML = '<option value="">Select Service Type</option>';
        items.forEach(item => {
          const option = document.createElement('option');
          option.value = item.service_type;
          option.textContent = `${item.service_type} - R${item.customer_display_price.toFixed(2)}`;
          option.dataset.pricing = JSON.stringify(item);
          typeSelect.appendChild(option);
        });
        typeSelect.disabled = false;
      }

      // Handle type selection
      function handleTypeChange(select) {
        const itemRow = select.closest('.item-row');
        const whiteContainer = itemRow.querySelector('#white-checkbox-container');
        const whiteCheckbox = itemRow.querySelector('.white-checkbox');
        const whiteLabel = itemRow.querySelector('.white-checkbox-label');
        
        const selectedOption = select.options[select.selectedIndex];
        if (!selectedOption.dataset.pricing) {
          whiteContainer.classList.add('hidden');
          return;
        }

        const pricing = JSON.parse(selectedOption.dataset.pricing);
        
        if (pricing.is_white_applicable) {
          whiteLabel.textContent = `Is this item white? (+R${pricing.color_surcharge_customer.toFixed(2)})`;
          whiteContainer.classList.remove('hidden');
          whiteCheckbox.dataset.surcharge = pricing.color_surcharge_customer;
        } else {
          whiteContainer.classList.add('hidden');
          whiteCheckbox.checked = false;
        }
        
        updateCart();
        updateSummary();
      }

      // Add new item row
      function addItemRow() {
        const container = document.getElementById('items-container');
        const template = container.querySelector('.item-row').cloneNode(true);
        
        // Reset template
        template.querySelector('.category-select').value = '';
        template.querySelector('.type-select').innerHTML = '<option value="">Select Category First</option>';
        template.querySelector('.type-select').disabled = true;
        template.querySelector('#white-checkbox-container').classList.add('hidden');
        template.querySelector('.white-checkbox').checked = false;
        template.querySelector('.quantity-input').value = 1;
        template.querySelector('.remove-item-btn').classList.remove('hidden');
        
        container.appendChild(template);
        populateCategoryDropdowns();
      }

      // Remove item row
      function removeItemRow(row) {
        if (document.querySelectorAll('.item-row').length > 1) {
          row.remove();
          updateCart();
          updateSummary();
        }
      }

      // Update cart items
      function updateCart() {
        cartItems = [];
        document.querySelectorAll('.item-row').forEach(row => {
          const category = row.querySelector('.category-select').value;
          const type = row.querySelector('.type-select').value;
          const quantity = parseInt(row.querySelector('.quantity-input').value) || 1;
          const isWhite = row.querySelector('.white-checkbox').checked;
          
          if (category && type) {
            const selectedOption = row.querySelector('.type-select').options[row.querySelector('.type-select').selectedIndex];
            if (selectedOption.dataset.pricing) {
              const pricing = JSON.parse(selectedOption.dataset.pricing);
              cartItems.push({ category, type, quantity, isWhite, pricing });
            }
          }
        });
      }

      // Update summary display
      function updateSummary() {
        const itemsList = document.getElementById('booking-items-list');
        const totalPriceEl = document.getElementById('total-price');
        const subtotalPriceEl = document.getElementById('subtotal-price');
        const subtotalSection = document.getElementById('subtotal-section');
        
        if (cartItems.length === 0) {
          itemsList.innerHTML = '<p class="text-gray-500">Add items to see your booking summary</p>';
          totalPriceEl.textContent = 'R0.00';
          subtotalSection.style.display = 'none';
          return;
        }

        let subtotal = 0;
        itemsList.innerHTML = '';
        
        cartItems.forEach(item => {
          let price = item.pricing.customer_display_price;
          if (item.isWhite && item.pricing.is_white_applicable) {
            price += item.pricing.color_surcharge_customer;
          }
          const lineTotal = price * item.quantity;
          subtotal += lineTotal;
          
          const itemEl = document.createElement('div');
          const whiteText = item.isWhite ? ' (White)' : '';
          itemEl.className = 'flex justify-between text-sm';
          itemEl.innerHTML = `
            <span>• ${item.type}${whiteText} × ${item.quantity}</span>
            <span class="font-semibold">R${lineTotal.toFixed(2)}</span>
          `;
          itemsList.appendChild(itemEl);
        });
        
        // Add callout fee to total
        const total = subtotal + CALLOUT_FEE;
        
        subtotalPriceEl.textContent = `R${subtotal.toFixed(2)}`;
        totalPriceEl.textContent = `R${total.toFixed(2)}`;
        subtotalSection.style.display = 'block';
      }

      // Handle form submission
      async function handleSubmit(e) {
        e.preventDefault();
        
        updateCart();
        
        if (cartItems.length === 0) {
          alert('Please add at least one service item');
          return;
        }

        const formData = new FormData(e.target);
        const bookingData = {
          customer_name: formData.get('customer_name'),
          customer_email: formData.get('customer_email'),
          customer_phone: formData.get('customer_phone'),
          customer_address: formData.get('customer_address'),
          unit_number: formData.get('unit_number'),
          complex_name: formData.get('complex_name'),
          access_instructions: formData.get('access_instructions'),
          preferred_date: formData.get('preferred_date'),
          preferred_time: formData.get('preferred_time'),
          additional_notes: formData.get('additional_notes'),
          items: cartItems.map(item => ({
            category: item.category,
            type: item.type,
            quantity: item.quantity,
            is_white: item.isWhite
          }))
        };

        // Show loading
        document.getElementById('loading-overlay').classList.remove('hidden');

        try {
          const response = await fetch(`${API_BASE_URL}/api/service-requests`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookingData)
          });

          const result = await response.json();

          if (response.ok) {
            window.location.href = `booking-success.html?request_id=${result.request_id}&total=${result.total_customer_paid}`;
          } else {
            alert(result.error || 'Error creating booking');
            document.getElementById('loading-overlay').classList.add('hidden');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Network error. Please try again.');
          document.getElementById('loading-overlay').classList.add('hidden');
        }
      }
    </script>
  </body>
</html>

