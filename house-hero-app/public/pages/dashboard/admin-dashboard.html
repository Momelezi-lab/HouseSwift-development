<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Admin Dashboard | HouseHero</title>
    <meta name="theme-color" content="#3b82f6" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background: #f8fafc;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        margin: 0;
        padding: 0;
      }
      .admin-layout {
        display: flex;
        min-height: 100vh;
      }
      .admin-sidebar {
        width: 220px;
        background: #10169f;
        color: #fff;
        display: flex;
        flex-direction: column;
        padding: 2rem 1rem;
      }
      .admin-sidebar h2 {
        font-size: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
        letter-spacing: 1px;
        font-weight: 700;
      }
      .admin-nav {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .admin-nav a {
        color: #fff;
        text-decoration: none;
        font-size: 1rem;
        padding: 0.8rem 1rem;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        transition: all 0.3s ease;
        font-weight: 500;
      }
      .admin-nav a.active,
      .admin-nav a:hover {
        background: #1e40af;
      }
      .admin-main {
        flex: 1;
        padding: 2.5rem 2rem;
        background: #f8fafc;
      }
      .admin-widgets {
        display: flex;
        gap: 2rem;
        margin-bottom: 2.5rem;
        flex-wrap: wrap;
      }
      .admin-widget {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.06);
        padding: 2rem 2.5rem;
        flex: 1 1 180px;
        min-width: 180px;
        text-align: center;
      }
      .admin-widget h3 {
        color: #3b82f6;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
      }
      .admin-widget .widget-value {
        font-size: 2.1rem;
        font-weight: bold;
        color: #111;
      }
      .latest-bookings {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.06);
        padding: 2rem;
      }
      .latest-bookings h4 {
        color: #3b82f6;
        margin-bottom: 1.2rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 12px;
        overflow: hidden;
      }
      th,
      td {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
      }
      th {
        background: #3b82f6;
        color: #fff;
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover {
        background: #f8fafc;
      }
      .admin-login {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 8vh;
      }
      .admin-login input {
        padding: 1rem 1.2rem;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        width: 300px;
        transition: all 0.3s ease;
      }
      .admin-login input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      .admin-login button {
        padding: 0.7rem 2rem;
        border-radius: 8px;
        background: #10169f;
        color: #fff;
        border: none;
        font-size: 1.1rem;
        cursor: pointer;
      }
      .admin-login .error {
        color: #ef4444;
        margin-top: 0.5rem;
        font-weight: 500;
      }
      @media (max-width: 900px) {
        .admin-widgets {
          grid-template-columns: 1fr;
          gap: 1rem;
        }
        .admin-sidebar {
          width: 80px;
          padding: 1rem 0.5rem;
        }
        .admin-sidebar h2 {
          font-size: 0.8rem;
        }
        .admin-nav a {
          font-size: 0.8rem;
          padding: 0.6rem 0.5rem;
          justify-content: center;
        }
        .admin-nav a span {
          display: none;
        }
      }
      /* Override admin sidebar nav button hover effect */
      .admin-nav a.admin-nav-btn:hover,
      .admin-nav a.admin-nav-btn.active {
        background: rgba(255, 255, 255, 0.15) !important;
        color: #fff !important;
        transform: translateX(4px) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
      }
      .round-back-btn {
        position: fixed;
        top: auto;
        bottom: 32px;
        left: 240px;
        width: 48px;
        height: 48px;
        background: #10169f;
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.18);
        font-size: 1.5rem;
        z-index: 10001;
        text-decoration: none;
        border: none;
        transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
      }
      .round-back-btn:hover {
        background: #1e40af;
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.22);
        transform: scale(1.08);
      }
      @media (max-width: 900px) {
        .round-back-btn {
          left: 100px;
        }
      }
      .latest-bookings table,
      .latest-bookings th,
      .latest-bookings td {
        color: #1e293b !important;
        background: #fff;
      }
      .latest-bookings th {
        background: #3b82f6;
        color: #fff !important;
      }

      /* Enhanced button styles */
      .btn-primary {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: #fff;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        color: #fff;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
      }

      /* Section headers */
      .section-header {
        color: #3b82f6;
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* Status badges */
      .status-badge {
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: capitalize;
      }
      .status-active {
        background: #dcfce7;
        color: #166534;
      }
      .status-pending {
        background: #fef3c7;
        color: #92400e;
      }
      .status-inactive {
        background: #fee2e2;
        color: #dc2626;
      }

      /* Dark mode toggle button */
      .dark-mode-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #3b82f6;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        transition: all 0.3s ease;
      }
      .dark-mode-toggle:hover {
        background: #1e40af;
        transform: scale(1.1);
      }

      /* Dark mode styles */
      .dark body {
        background: #1e293b !important;
        color: #e2e8f0 !important;
      }

      .dark .admin-main {
        background: #1e293b !important;
      }

      .dark .admin-widget {
        background: #334155 !important;
        color: #e2e8f0 !important;
        border: 1px solid #475569 !important;
      }

      .dark .admin-widget .widget-value {
        color: #f1f5f9 !important;
      }

      .dark .latest-bookings {
        background: #334155 !important;
        color: #e2e8f0 !important;
        border: 1px solid #475569 !important;
      }

      .dark .admin-analytics {
        background: #334155 !important;
        color: #e2e8f0 !important;
        border: 1px solid #475569 !important;
      }

      .dark table {
        background: #334155 !important;
        color: #e2e8f0 !important;
      }

      .dark th {
        background: #1e40af !important;
        color: #fff !important;
      }

      .dark td {
        border-bottom: 1px solid #475569 !important;
        color: #e2e8f0 !important;
      }

      .dark tr:hover {
        background: #475569 !important;
      }

      .dark .admin-login {
        background: #334155 !important;
        color: #e2e8f0 !important;
      }

      .dark .admin-login input {
        background: #475569 !important;
        color: #e2e8f0 !important;
        border: 1px solid #64748b !important;
      }

      .dark .admin-login input::placeholder {
        color: #94a3b8 !important;
      }

      .dark .admin-login button {
        background: #3b82f6 !important;
        color: #fff !important;
      }

      .dark .admin-login button:hover {
        background: #1e40af !important;
      }
    </style>
  </head>
  <body>
    <a
      href="../auth/login.html"
      class="back-btn round-back-btn"
      title="Back to Login"
    >
      <i class="fa fa-arrow-left"></i>
    </a>
    <button id="toggle-dark" class="dark-mode-toggle" title="Toggle Dark Mode">
      ☀️
    </button>
    <div class="admin-login" id="admin-login">
      <h2>Admin Login</h2>
      <input type="password" id="admin-password" placeholder="Enter password" />
      <button id="admin-login-btn">Login</button>
      <div class="error" id="admin-error" style="display: none">
        Incorrect password.
      </div>
    </div>
    <div class="admin-layout" id="admin-content" style="display: none">
      <aside class="admin-sidebar">
        <h2><i class="fa-solid fa-user-shield"></i> Admin</h2>
        <nav class="admin-nav">
          <a href="#" id="nav-dashboard" class="admin-nav-btn active"
            ><i class="fa-solid fa-chart-line"></i> <span>Dashboard</span></a
          >
          <a href="#" id="nav-bookings" class="admin-nav-btn"
            ><i class="fa-solid fa-calendar-check"></i> <span>Bookings</span></a
          >
          <a href="#" id="nav-users" class="admin-nav-btn"
            ><i class="fa-solid fa-users"></i> <span>Users</span></a
          >
          <a href="#" id="nav-services" class="admin-nav-btn"
            ><i class="fa-solid fa-broom"></i> <span>Services</span></a
          >
          <a href="#" id="nav-providers" class="admin-nav-btn"
            ><i class="fa-solid fa-user-tie"></i> <span>Providers</span></a
          >
          <a href="#" id="nav-complaints" class="admin-nav-btn"
            ><i class="fa-solid fa-exclamation-triangle"></i>
            <span>Complaints</span></a
          >
          <a href="#" id="nav-service-requests" class="admin-nav-btn"
            ><i class="fa-solid fa-clipboard-list"></i>
            <span>Service Requests</span></a
          >
          <a href="#" id="nav-financial" class="admin-nav-btn"
            ><i class="fa-solid fa-chart-line"></i>
            <span>Financial Reports</span></a
          >
        </nav>
      </aside>
      <main class="admin-main">
        <section id="dashboard-section">
          <div class="admin-widgets">
            <div class="admin-widget">
              <h3>Total Bookings</h3>
              <div class="widget-value" id="total-bookings">0</div>
            </div>
            <div class="admin-widget">
              <h3>Total Users</h3>
              <div class="widget-value" id="total-users">1</div>
            </div>
            <div class="admin-widget">
              <h3>Total Earnings</h3>
              <div class="widget-value" id="total-earnings">R12789890</div>
            </div>
            <div class="admin-widget">
              <h3>Total Complaints</h3>
              <div class="widget-value" id="total-complaints">0</div>
            </div>
          </div>

          <!-- Analytics Section -->
          <div
            class="admin-analytics"
            style="
              background: #fff;
              border-radius: 16px;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
              padding: 2rem;
              margin-bottom: 2.5rem;
              border: 1px solid rgba(59, 130, 246, 0.1);
            "
          >
            <h4
              style="
                color: #3b82f6;
                margin-bottom: 1.5rem;
                font-weight: 600;
                font-size: 1.3rem;
              "
            >
              Bookings Per Month
            </h4>
            <canvas id="bookingsChart" height="80"></canvas>
            <div
              style="
                display: flex;
                gap: 2rem;
                flex-wrap: wrap;
                margin-top: 2.5rem;
              "
            >
              <div style="flex: 1; min-width: 260px; text-align: center">
                <h4
                  style="color: #3b82f6; margin-bottom: 1rem; font-weight: 600"
                >
                  Booking Status
                </h4>
                <canvas id="statusChart" height="120"></canvas>
              </div>
              <div style="flex: 1; min-width: 260px; text-align: center">
                <h4
                  style="color: #3b82f6; margin-bottom: 1rem; font-weight: 600"
                >
                  Earnings vs Expenses
                </h4>
                <canvas id="financeChart" height="120"></canvas>
              </div>
            </div>
            <div style="margin-top: 2.5rem; text-align: center">
              <h4 style="color: #3b82f6; margin-bottom: 1rem; font-weight: 600">
                Bookings by Service Type
              </h4>
              <canvas id="serviceTypeChart" height="120"></canvas>
            </div>
            <div style="margin-top: 2.5rem; text-align: center">
              <h4 style="color: #3b82f6; margin-bottom: 1rem; font-weight: 600">
                User Growth Over Time
              </h4>
              <canvas id="userGrowthChart" height="120"></canvas>
            </div>
            <div style="margin-top: 2.5rem; text-align: center">
              <h4 style="color: #3b82f6; margin-bottom: 1rem; font-weight: 600">
                Revenue by Service
              </h4>
              <canvas id="revenueServiceChart" height="120"></canvas>
            </div>
            <div style="margin-top: 2.5rem; text-align: center">
              <h4 style="color: #3b82f6; margin-bottom: 1rem; font-weight: 600">
                Complaints Statistics
              </h4>
              <canvas id="complaintsStatsChart" height="120"></canvas>
            </div>
          </div>

          <div class="latest-bookings">
            <h4>Latest Bookings</h4>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Address</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Service</th>
                  <th>Details</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="latest-bookings-table"></tbody>
            </table>
          </div>
        </section>
        <section id="bookings-section" style="display: none">
          <h2 style="color: #10169f">All Bookings</h2>
          <table style="margin-top: 1.5rem">
            <thead>
              <tr>
                <th>Name</th>
                <th>Address</th>
                <th>Date</th>
                <th>Time</th>
                <th>Service</th>
                <th>Details</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="all-bookings-table"></tbody>
          </table>
        </section>
        <section id="users-section" style="display: none">
          <h2 style="color: #10169f">Users</h2>
          <div style="margin-bottom: 1rem">
            <input
              type="text"
              id="user-search"
              placeholder="Search users..."
              style="
                padding: 0.5rem;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                width: 300px;
                margin-right: 1rem;
              "
            />
            <button
              id="refresh-users-btn"
              style="
                background: #10169f;
                color: #fff;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 6px;
                cursor: pointer;
              "
            >
              Refresh
            </button>
          </div>
          <table
            style="width: 100%; border-collapse: collapse; margin-top: 1rem"
          >
            <thead>
              <tr style="background: #f3f4f6">
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  ID
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Name
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Email
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Phone
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Registered
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="users-table">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
          <div
            id="users-loading"
            style="text-align: center; padding: 2rem; display: none"
          >
            Loading users...
          </div>
          <div
            id="users-empty"
            style="text-align: center; padding: 2rem; display: none"
          >
            No users found.
          </div>

          <!-- User Details Modal -->
          <div
            id="user-details-modal"
            style="
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background: rgba(0, 0, 0, 0.5);
              z-index: 10000;
              align-items: center;
              justify-content: center;
            "
          >
            <div
              style="
                background: #fff;
                padding: 2rem;
                border-radius: 12px;
                min-width: 500px;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
              "
            >
              <button
                id="close-user-modal"
                style="
                  position: absolute;
                  top: 1rem;
                  right: 1rem;
                  background: none;
                  border: none;
                  font-size: 1.5rem;
                  cursor: pointer;
                  color: #666;
                "
              >
                &times;
              </button>

              <h3
                id="user-modal-title"
                style="color: #22c55e; margin-bottom: 1.5rem; font-size: 1.5rem"
              >
                User Details
              </h3>

              <div id="user-details-content">
                <!-- User details will be populated here -->
              </div>

              <div style="display: flex; gap: 1rem; margin-top: 2rem">
                <button
                  type="button"
                  id="close-user-details"
                  style="
                    flex: 1;
                    padding: 0.75rem;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    background: #fff;
                    color: #374151;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                  "
                >
                  Close
                </button>
                <button
                  type="button"
                  id="edit-user-btn"
                  style="
                    flex: 1;
                    padding: 0.75rem;
                    border: none;
                    border-radius: 8px;
                    background: #3b82f6;
                    color: #fff;
                    font-weight: 600;
                    cursor: pointer;
                    transition: background-color 0.2s;
                  "
                >
                  Edit User
                </button>
              </div>
            </div>
          </div>

          <!-- User Edit Modal -->
          <div
            id="user-edit-modal"
            style="
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background: rgba(0, 0, 0, 0.5);
              z-index: 10001;
              align-items: center;
              justify-content: center;
            "
          >
            <div
              style="
                background: #fff;
                padding: 2rem;
                border-radius: 12px;
                min-width: 500px;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
              "
            >
              <button
                id="close-user-edit-modal"
                style="
                  position: absolute;
                  top: 1rem;
                  right: 1rem;
                  background: none;
                  border: none;
                  font-size: 1.5rem;
                  cursor: pointer;
                  color: #666;
                "
              >
                &times;
              </button>

              <h3
                id="user-edit-modal-title"
                style="color: #22c55e; margin-bottom: 1.5rem; font-size: 1.5rem"
              >
                Edit User
              </h3>

              <form id="user-edit-form">
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Full Name</label
                  >
                  <input
                    type="text"
                    id="edit-user-name"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      transition: border-color 0.2s;
                    "
                  />
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Email Address</label
                  >
                  <input
                    type="email"
                    id="edit-user-email"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                    "
                  />
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Phone Number</label
                  >
                  <input
                    type="tel"
                    id="edit-user-phone"
                    placeholder="e.g., +27 123 456 789"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                    "
                  />
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Account Status</label
                  >
                  <select
                    id="edit-user-status"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      background: #fff;
                    "
                  >
                    <option value="active">Active</option>
                    <option value="suspended">Suspended</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >User Role</label
                  >
                  <select
                    id="edit-user-role"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      background: #fff;
                    "
                  >
                    <option value="customer">Customer</option>
                    <option value="admin">Admin</option>
                    <option value="provider">Service Provider</option>
                  </select>
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Address</label
                  >
                  <textarea
                    id="edit-user-address"
                    rows="3"
                    placeholder="Enter user's address"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      resize: vertical;
                      font-family: inherit;
                    "
                  ></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem">
                  <button
                    type="button"
                    id="cancel-user-edit"
                    style="
                      flex: 1;
                      padding: 0.75rem;
                      border: 2px solid #e5e7eb;
                      border-radius: 8px;
                      background: #fff;
                      color: #374151;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.2s;
                    "
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    id="save-user-changes"
                    style="
                      flex: 1;
                      padding: 0.75rem;
                      border: none;
                      border-radius: 8px;
                      background: #22c55e;
                      color: #fff;
                      font-weight: 600;
                      cursor: pointer;
                      transition: background-color 0.2s;
                    "
                  >
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>
        <section id="service-requests-section" style="display: none">
          <div class="flex justify-between items-center mb-6">
            <h2 style="color: #10169f; font-size: 1.8rem; font-weight: 700">Service Requests Management</h2>
            <div class="flex gap-4">
              <input type="text" id="request-search-input" placeholder="Search requests..." style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; width: 250px;">
              <select id="request-status-filter" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          
          <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.06); overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="background: #3b82f6; color: #fff;">
                <tr>
                  <th style="padding: 1rem; text-align: left;">Request ID</th>
                  <th style="padding: 1rem; text-align: left;">Customer</th>
                  <th style="padding: 1rem; text-align: left;">Service</th>
                  <th style="padding: 1rem; text-align: left;">Date</th>
                  <th style="padding: 1rem; text-align: left;">Status</th>
                  <th style="padding: 1rem; text-align: left;">Customer Paid</th>
                  <th style="padding: 1rem; text-align: left;">Provider Gets</th>
                  <th style="padding: 1rem; text-align: left;">Commission</th>
                  <th style="padding: 1rem; text-align: left;">Actions</th>
                </tr>
              </thead>
              <tbody id="service-requests-table-body">
                <!-- Service requests will be loaded here -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Service Request Detail Modal -->
        <div id="service-request-detail-modal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
          <div style="background: #fff; border-radius: 12px; padding: 2rem; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
            <button onclick="closeServiceRequestDetail()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">✕</button>
            <h2 style="color: #10169f; font-size: 1.8rem; margin-bottom: 1.5rem;">Request Details</h2>
            <div id="service-request-detail-content">
              <!-- Request details will be loaded here -->
            </div>
          </div>
        </div>

        <section id="financial-section" style="display: none">
          <h2 style="color: #10169f; font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem">Financial Reports</h2>
          <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
            <input type="date" id="financial-report-from" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px;">
            <input type="date" id="financial-report-to" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px;">
            <button onclick="loadFinancialReport()" style="background: #3b82f6; color: #fff; padding: 0.5rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Apply Filters</button>
            <button onclick="exportFinancialReport()" style="background: #22c55e; color: #fff; padding: 0.5rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Export CSV</button>
          </div>
          <div id="financial-report-content" style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.06); padding: 2rem;">
            <!-- Financial report will be loaded here -->
          </div>
        </section>

        <section id="complaints-section" style="display: none">
          <h2 style="color: #10169f">Complaints Management</h2>
          <div style="margin-bottom: 1rem">
            <select
              id="complaint-status-filter"
              style="
                padding: 0.5rem;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                margin-right: 1rem;
              "
            >
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="in-progress">In Progress</option>
              <option value="resolved">Resolved</option>
              <option value="closed">Closed</option>
            </select>
            <select
              id="complaint-type-filter"
              style="
                padding: 0.5rem;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                margin-right: 1rem;
              "
            >
              <option value="all">All Types</option>
              <option value="service-quality">Service Quality</option>
              <option value="professional-conduct">Professional Conduct</option>
              <option value="pricing-issues">Pricing Issues</option>
              <option value="scheduling-problems">Scheduling Problems</option>
              <option value="communication">Communication</option>
              <option value="safety-concerns">Safety Concerns</option>
              <option value="other">Other</option>
            </select>
            <button
              id="refresh-complaints-btn"
              style="
                background: #10169f;
                color: #fff;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 6px;
                cursor: pointer;
              "
            >
              Refresh
            </button>
          </div>
          <table
            style="width: 100%; border-collapse: collapse; margin-top: 1rem"
          >
            <thead>
              <tr style="background: #f3f4f6">
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  ID
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Name
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Type
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Title
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Status
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Date
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Urgency
                </th>
                <th
                  style="
                    padding: 0.75rem;
                    text-align: left;
                    border-bottom: 1px solid #d1d5db;
                  "
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="complaints-table">
              <!-- Complaints will be loaded here -->
            </tbody>
          </table>
          <div
            id="complaints-loading"
            style="text-align: center; padding: 2rem; display: none"
          >
            Loading complaints...
          </div>
          <div
            id="complaints-empty"
            style="text-align: center; padding: 2rem; display: none"
          >
            No complaints found.
          </div>
        </section>
        <section id="services-section" style="display: none">
          <h2 style="color: #10169f">Services Management</h2>

          <!-- Service Statistics -->
          <div
            style="
              display: flex;
              gap: 1rem;
              margin-bottom: 2rem;
              flex-wrap: wrap;
            "
          >
            <div
              style="
                background: #fff;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                min-width: 200px;
              "
            >
              <h3 style="color: #10169f; margin: 0 0 0.5rem 0">
                Total Services
              </h3>
              <div style="font-size: 2rem; font-weight: bold; color: #111">
                8
              </div>
            </div>
            <div
              style="
                background: #fff;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                min-width: 200px;
              "
            >
              <h3 style="color: #10169f; margin: 0 0 0.5rem 0">
                Active Services
              </h3>
              <div style="font-size: 2rem; font-weight: bold; color: #111">
                7
              </div>
            </div>
            <div
              style="
                background: #fff;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                min-width: 200px;
              "
            >
              <h3 style="color: #10169f; margin: 0 0 0.5rem 0">
                Total Bookings
              </h3>
              <div
                style="font-size: 2rem; font-weight: bold; color: #111"
                id="services-total-bookings"
              >
                0
              </div>
            </div>
          </div>

          <!-- Service Management Controls -->
          <div
            style="
              margin-bottom: 1.5rem;
              display: flex;
              gap: 1rem;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <button
              id="add-service-btn"
              style="
                background: #10169f;
                color: #fff;
                padding: 0.6rem 1.2rem;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
              "
            >
              + Add New Service
            </button>
            <select
              id="service-status-filter"
              style="
                padding: 0.5rem;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                margin-left: 1rem;
              "
            >
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="maintenance">Maintenance</option>
            </select>
            <button
              id="refresh-services-btn"
              style="
                background: #3b82f6;
                color: #fff;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 6px;
                cursor: pointer;
              "
            >
              Refresh
            </button>
          </div>

          <!-- Services Grid -->
          <div
            id="services-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
              gap: 1.5rem;
            "
          >
            <!-- Service cards will be loaded here -->
          </div>

          <!-- Loading and Empty States -->
          <div
            id="services-loading"
            style="text-align: center; padding: 3rem; display: none"
          >
            <div style="font-size: 1.2rem; color: #666">
              Loading services...
            </div>
          </div>
          <div
            id="services-empty"
            style="text-align: center; padding: 3rem; display: none"
          >
            <div style="font-size: 1.2rem; color: #666">No services found.</div>
          </div>

          <!-- Service Edit Modal -->
          <div
            id="service-edit-modal"
            style="
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background: rgba(0, 0, 0, 0.5);
              z-index: 10000;
              align-items: center;
              justify-content: center;
            "
          >
            <div
              style="
                background: #fff;
                padding: 2rem;
                border-radius: 12px;
                min-width: 400px;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
              "
            >
              <button
                id="close-service-modal"
                style="
                  position: absolute;
                  top: 1rem;
                  right: 1rem;
                  background: none;
                  border: none;
                  font-size: 1.5rem;
                  cursor: pointer;
                  color: #666;
                "
              >
                &times;
              </button>

              <h3
                id="service-modal-title"
                style="color: #22c55e; margin-bottom: 1.5rem; font-size: 1.5rem"
              >
                Edit Service
              </h3>

              <form id="service-edit-form">
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Service Name</label
                  >
                  <input
                    type="text"
                    id="edit-service-name"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      transition: border-color 0.2s;
                    "
                  />
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Category</label
                  >
                  <select
                    id="edit-service-category"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      background: #fff;
                    "
                  >
                    <option value="Cleaning">Cleaning</option>
                    <option value="Repair">Repair</option>
                    <option value="Outdoor">Outdoor</option>
                    <option value="Security">Security</option>
                    <option value="HVAC">HVAC</option>
                    <option value="Health">Health</option>
                    <option value="Other">Other</option>
                  </select>
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Description</label
                  >
                  <textarea
                    id="edit-service-description"
                    required
                    rows="3"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      resize: vertical;
                      font-family: inherit;
                    "
                  ></textarea>
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Price Range</label
                  >
                  <input
                    type="text"
                    id="edit-service-price"
                    required
                    placeholder="e.g., R200-500"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                    "
                  />
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Status</label
                  >
                  <select
                    id="edit-service-status"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      background: #fff;
                    "
                  >
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="maintenance">Maintenance</option>
                  </select>
                </div>

                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Icon (Emoji)</label
                  >
                  <input
                    type="text"
                    id="edit-service-icon"
                    required
                    placeholder="e.g., 🧹"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1.5rem;
                      text-align: center;
                    "
                  />
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem">
                  <button
                    type="button"
                    id="cancel-service-edit"
                    style="
                      flex: 1;
                      padding: 0.75rem;
                      border: 2px solid #e5e7eb;
                      border-radius: 8px;
                      background: #fff;
                      color: #374151;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.2s;
                    "
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    id="save-service-changes"
                    style="
                      flex: 1;
                      padding: 0.75rem;
                      border: none;
                      border-radius: 8px;
                      background: #22c55e;
                      color: #fff;
                      font-weight: 600;
                      cursor: pointer;
                      transition: background-color 0.2s;
                    "
                  >
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>
        <section id="provider-section" style="display: none">
          <h2 style="color: #10169f; margin-bottom: 1.5rem; font-size: 1.8rem">
            Service Providers
          </h2>

          <!-- Provider Statistics -->
          <div
            style="
              display: flex;
              gap: 1rem;
              margin-bottom: 2rem;
              flex-wrap: wrap;
            "
          >
            <div
              style="
                background: #fff;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                min-width: 200px;
              "
            >
              <h3 style="color: #10169f; margin: 0 0 0.5rem 0">
                Total Providers
              </h3>
              <div
                style="font-size: 2rem; font-weight: bold; color: #111"
                id="providers-total"
              >
                0
              </div>
            </div>
            <div
              style="
                background: #fff;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                min-width: 200px;
              "
            >
              <h3 style="color: #10169f; margin: 0 0 0.5rem 0">
                Active Providers
              </h3>
              <div
                style="font-size: 2rem; font-weight: bold; color: #111"
                id="providers-active"
              >
                0
              </div>
            </div>
            <div
              style="
                background: #fff;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                min-width: 200px;
              "
            >
              <h3 style="color: #10169f; margin: 0 0 0.5rem 0">Avg Rating</h3>
              <div
                style="font-size: 2rem; font-weight: bold; color: #111"
                id="providers-avg-rating"
              >
                0.0
              </div>
            </div>
          </div>

          <!-- Provider Management Controls -->
          <div
            style="
              margin-bottom: 1.5rem;
              display: flex;
              gap: 1rem;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <button
              id="add-provider-btn"
              style="
                background: #10169f;
                color: #fff;
                padding: 0.6rem 1.2rem;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: background-color 0.2s;
              "
            >
              + Add Provider
            </button>
            <select
              id="provider-status-filter"
              style="
                padding: 0.5rem;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                margin-left: 1rem;
              "
            >
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="suspended">Suspended</option>
            </select>
            <select
              id="provider-service-filter"
              style="
                padding: 0.5rem;
                border: 1px solid #d1d5db;
                border-radius: 6px;
              "
            >
              <option value="all">All Services</option>
              <option value="House Cleaning">House Cleaning</option>
              <option value="Plumbing">Plumbing</option>
              <option value="Electrical">Electrical</option>
              <option value="Gardening">Gardening</option>
              <option value="Handyman">Handyman</option>
              <option value="Locksmith">Locksmith</option>
              <option value="Air Conditioning">Air Conditioning</option>
              <option value="Pest Control">Pest Control</option>
            </select>
            <button
              id="refresh-providers-btn"
              style="
                background: #10169f;
                color: #fff;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 6px;
                cursor: pointer;
              "
            >
              Refresh
            </button>
          </div>

          <!-- Providers Table -->
          <div
            style="
              background: #fff;
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
              overflow: hidden;
            "
          >
            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr
                  style="background: #f8fafc; border-bottom: 2px solid #e5e7eb"
                >
                  <th
                    style="
                      padding: 1rem;
                      text-align: left;
                      font-weight: 600;
                      color: #374151;
                    "
                  >
                    Name
                  </th>
                  <th
                    style="
                      padding: 1rem;
                      text-align: left;
                      font-weight: 600;
                      color: #374151;
                    "
                  >
                    Service Type
                  </th>
                  <th
                    style="
                      padding: 1rem;
                      text-align: left;
                      font-weight: 600;
                      color: #374151;
                    "
                  >
                    Phone
                  </th>
                  <th
                    style="
                      padding: 1rem;
                      text-align: left;
                      font-weight: 600;
                      color: #374151;
                    "
                  >
                    Email
                  </th>
                  <th
                    style="
                      padding: 1rem;
                      text-align: left;
                      font-weight: 600;
                      color: #374151;
                    "
                  >
                    Performance
                  </th>
                  <th
                    style="
                      padding: 1rem;
                      text-align: left;
                      font-weight: 600;
                      color: #374151;
                    "
                  >
                    Status
                  </th>
                  <th
                    style="
                      padding: 1rem;
                      text-align: center;
                      font-weight: 600;
                      color: #374151;
                    "
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="provider-table">
                <!-- Providers will be listed here -->
              </tbody>
            </table>
          </div>
          <div
            id="providers-loading"
            style="text-align: center; padding: 2rem; display: none"
          >
            Loading providers...
          </div>
          <div
            id="providers-empty"
            style="text-align: center; padding: 2rem; display: none"
          >
            No providers found.
          </div>
          <!-- Provider Add Modal (hidden by default) -->
          <div
            id="provider-modal"
            style="
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background: rgba(0, 0, 0, 0.5);
              z-index: 10000;
              align-items: center;
              justify-content: center;
            "
          >
            <div
              style="
                background: #fff;
                padding: 2rem 2.5rem;
                border-radius: 12px;
                min-width: 320px;
                max-width: 90vw;
                position: relative;
              "
            >
              <button
                id="close-provider-modal"
                style="
                  position: absolute;
                  top: 1rem;
                  right: 1rem;
                  background: none;
                  border: none;
                  font-size: 1.5rem;
                  cursor: pointer;
                "
              >
                &times;
              </button>
              <h3
                id="provider-modal-title"
                style="color: #22c55e; margin-bottom: 1rem"
              >
                Add Provider
              </h3>
              <form id="provider-form">
                <div style="margin-bottom: 1rem">
                  <label>Name</label><br />
                  <input
                    type="text"
                    id="provider-name"
                    required
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                    "
                  />
                </div>
                <div style="margin-bottom: 1rem">
                  <label>Service Type</label><br />
                  <select
                    id="provider-service"
                    required
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                    "
                  >
                    <option value="">Select Service Type</option>
                    <option value="House Cleaning">House Cleaning</option>
                    <option value="Plumbing">Plumbing</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Gardening">Gardening</option>
                    <option value="Handyman">Handyman</option>
                    <option value="Locksmith">Locksmith</option>
                    <option value="Air Conditioning">Air Conditioning</option>
                    <option value="Pest Control">Pest Control</option>
                  </select>
                </div>
                <div style="margin-bottom: 1rem">
                  <label>Phone</label><br />
                  <input
                    type="tel"
                    id="provider-phone"
                    required
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                    "
                  />
                </div>
                <div style="margin-bottom: 1rem">
                  <label>Email</label><br />
                  <input
                    type="email"
                    id="provider-email"
                    required
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                    "
                  />
                </div>
                <div style="margin-bottom: 1rem">
                  <label>Address</label><br />
                  <textarea
                    id="provider-address"
                    rows="2"
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                      resize: vertical;
                    "
                  ></textarea>
                </div>
                <div style="margin-bottom: 1rem">
                  <label>Experience (Years)</label><br />
                  <input
                    type="number"
                    id="provider-experience"
                    min="0"
                    value="0"
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                    "
                  />
                </div>
                <div style="margin-bottom: 1rem">
                  <label>Hourly Rate (R)</label><br />
                  <input
                    type="number"
                    id="provider-rate"
                    min="0"
                    step="0.01"
                    value="0"
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                    "
                  />
                </div>
                <div style="margin-bottom: 1rem">
                  <label>Rating (0-5)</label><br />
                  <input
                    type="number"
                    id="provider-rating"
                    min="0"
                    max="5"
                    step="0.1"
                    value="0"
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                    "
                  />
                </div>
                <div style="margin-bottom: 1rem">
                  <label>Total Bookings</label><br />
                  <input
                    type="number"
                    id="provider-bookings"
                    min="0"
                    value="0"
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                    "
                  />
                </div>
                <div style="margin-bottom: 1rem">
                  <label>Status</label><br />
                  <select
                    id="provider-status"
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border-radius: 6px;
                      border: 1px solid #d1d5db;
                    "
                  >
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="suspended">Suspended</option>
                  </select>
                </div>
                <button
                  type="submit"
                  style="
                    background: #22c55e;
                    color: #fff;
                    padding: 0.6rem 1.2rem;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                  "
                >
                  Save
                </button>
              </form>
            </div>
          </div>

          <!-- Provider Details Modal -->
          <div
            id="provider-details-modal"
            style="
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background: rgba(0, 0, 0, 0.5);
              z-index: 10001;
              align-items: center;
              justify-content: center;
            "
          >
            <div
              style="
                background: #fff;
                padding: 2rem;
                border-radius: 12px;
                min-width: 500px;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
              "
            >
              <button
                id="close-provider-details-modal"
                style="
                  position: absolute;
                  top: 1rem;
                  right: 1rem;
                  background: none;
                  border: none;
                  font-size: 1.5rem;
                  cursor: pointer;
                  color: #666;
                "
              >
                &times;
              </button>
              <h3
                id="provider-details-modal-title"
                style="color: #22c55e; margin-bottom: 1.5rem; font-size: 1.5rem"
              >
                Provider Details
              </h3>
              <div id="provider-details-content">
                <!-- Provider details will be populated here -->
              </div>
              <div style="display: flex; gap: 1rem; margin-top: 2rem">
                <button
                  type="button"
                  id="close-provider-details"
                  style="
                    flex: 1;
                    padding: 0.75rem;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    background: #fff;
                    color: #374151;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                  "
                >
                  Close
                </button>
                <button
                  type="button"
                  id="edit-provider-btn"
                  style="
                    flex: 1;
                    padding: 0.75rem;
                    border: none;
                    border-radius: 8px;
                    background: #3b82f6;
                    color: #fff;
                    font-weight: 600;
                    cursor: pointer;
                    transition: background-color 0.2s;
                  "
                >
                  Edit Provider
                </button>
              </div>
            </div>
          </div>

          <!-- Provider Edit Modal -->
          <div
            id="provider-edit-modal"
            style="
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background: rgba(0, 0, 0, 0.5);
              z-index: 10002;
              align-items: center;
              justify-content: center;
            "
          >
            <div
              style="
                background: #fff;
                padding: 2rem;
                border-radius: 12px;
                min-width: 500px;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
              "
            >
              <button
                id="close-provider-edit-modal"
                style="
                  position: absolute;
                  top: 1rem;
                  right: 1rem;
                  background: none;
                  border: none;
                  font-size: 1.5rem;
                  cursor: pointer;
                  color: #666;
                "
              >
                &times;
              </button>
              <h3
                id="provider-edit-modal-title"
                style="color: #22c55e; margin-bottom: 1.5rem; font-size: 1.5rem"
              >
                Edit Provider
              </h3>
              <form id="provider-edit-form">
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Full Name</label
                  >
                  <input
                    type="text"
                    id="edit-provider-name"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      transition: border-color 0.2s;
                    "
                  />
                </div>
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Service Type</label
                  >
                  <select
                    id="edit-provider-service"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      background: #fff;
                    "
                  >
                    <option value="">Select Service Type</option>
                    <option value="House Cleaning">House Cleaning</option>
                    <option value="Plumbing">Plumbing</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Gardening">Gardening</option>
                    <option value="Handyman">Handyman</option>
                    <option value="Locksmith">Locksmith</option>
                    <option value="Air Conditioning">Air Conditioning</option>
                    <option value="Pest Control">Pest Control</option>
                  </select>
                </div>
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Phone Number</label
                  >
                  <input
                    type="tel"
                    id="edit-provider-phone"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                    "
                  />
                </div>
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Email Address</label
                  >
                  <input
                    type="email"
                    id="edit-provider-email"
                    required
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                    "
                  />
                </div>
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Address</label
                  >
                  <textarea
                    id="edit-provider-address"
                    rows="3"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      resize: vertical;
                      font-family: inherit;
                    "
                  ></textarea>
                </div>
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Experience (Years)</label
                  >
                  <input
                    type="number"
                    id="edit-provider-experience"
                    min="0"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                    "
                  />
                </div>
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Hourly Rate (R)</label
                  >
                  <input
                    type="number"
                    id="edit-provider-rate"
                    min="0"
                    step="0.01"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                    "
                  />
                </div>
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Rating (0-5)</label
                  >
                  <input
                    type="number"
                    id="edit-provider-rating"
                    min="0"
                    max="5"
                    step="0.1"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                    "
                  />
                </div>
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Total Bookings</label
                  >
                  <input
                    type="number"
                    id="edit-provider-bookings"
                    min="0"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                    "
                  />
                </div>
                <div style="margin-bottom: 1.5rem">
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: #374151;
                    "
                    >Status</label
                  >
                  <select
                    id="edit-provider-status"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border-radius: 8px;
                      border: 2px solid #e5e7eb;
                      font-size: 1rem;
                      background: #fff;
                    "
                  >
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="suspended">Suspended</option>
                  </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem">
                  <button
                    type="button"
                    id="cancel-provider-edit"
                    style="
                      flex: 1;
                      padding: 0.75rem;
                      border: 2px solid #e5e7eb;
                      border-radius: 8px;
                      background: #fff;
                      color: #374151;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.2s;
                    "
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    id="save-provider-changes"
                    style="
                      flex: 1;
                      padding: 0.75rem;
                      border: none;
                      border-radius: 8px;
                      background: #22c55e;
                      color: #fff;
                      font-weight: 600;
                      cursor: pointer;
                      transition: background-color 0.2s;
                    "
                  >
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/script.js"></script>
    <script>
      // Persistent admin login using localStorage
      function showAdminDashboard() {
        document.getElementById("admin-login").style.display = "none";
        document.getElementById("admin-content").style.display = "flex";
        loadDashboard();
        loadAllBookings();
        // Render charts
        console.log("Initial dashboard load - rendering charts...");
        if (typeof waitForChartJS === "function") {
          waitForChartJS(() => {
            console.log("Chart.js ready, rendering charts...");
            if (typeof renderRevenueByServiceChart === "function") {
              console.log("Calling renderRevenueByServiceChart...");
              renderRevenueByServiceChart();
            }
            if (typeof renderComplaintsStatsChart === "function") {
              console.log("Calling renderComplaintsStatsChart...");
              renderComplaintsStatsChart();
            }
          });
        } else {
          console.error("waitForChartJS function not found!");
        }
      }
      // On page load, show the last active section from localStorage
      function showActiveAdminSection() {
        const navs = [
          { id: "nav-dashboard", section: "dashboard-section" },
          { id: "nav-bookings", section: "bookings-section" },
          { id: "nav-users", section: "users-section" },
          { id: "nav-services", section: "services-section" },
          { id: "nav-providers", section: "provider-section" },
          { id: "nav-complaints", section: "complaints-section" },
          { id: "nav-service-requests", section: "service-requests-section" },
          { id: "nav-financial", section: "financial-section" },
        ];
        const activeSection =
          localStorage.getItem("adminActiveSection") || "dashboard-section";
        navs.forEach((nav) => {
          document.getElementById(nav.id).classList.remove("active");
          document.getElementById(nav.section).style.display = "none";
        });
        const activeNav = navs.find((n) => n.section === activeSection);
        if (activeNav) {
          document.getElementById(activeNav.id).classList.add("active");
          document.getElementById(activeSection).style.display = "";

          // Load section-specific data
          if (activeSection === "services-section") {
            loadServices();
          }
          if (activeSection === "provider-section") {
            loadProviders();
          }
          if (activeSection === "service-requests-section") {
            loadServiceRequests();
          }
          if (activeSection === "financial-section") {
            loadFinancialReport();
          }
        }
      }
      // On page load, check admin login state
      if (localStorage.getItem("isAdminLoggedIn") === "true") {
        showAdminDashboard();
        showActiveAdminSection();
      }
      document.getElementById("admin-login-btn").onclick = function () {
        const pw = document.getElementById("admin-password").value;
        if (pw === "flower") {
          localStorage.setItem("isAdminLoggedIn", "true");
          showAdminDashboard();
        } else {
          document.getElementById("admin-error").style.display = "block";
        }
      };
      // Add admin logout button
      const logoutBtn = document.createElement("button");
      logoutBtn.textContent = "Logout";
      logoutBtn.style =
        "position:fixed;top:24px;right:32px;background:#ef4444;color:#fff;padding:0.5rem 1.2rem;border:none;border-radius:8px;cursor:pointer;font-weight:600;z-index:10001;";
      logoutBtn.onclick = function () {
        localStorage.removeItem("isAdminLoggedIn");
        document.getElementById("admin-content").style.display = "none";
        document.getElementById("admin-login").style.display = "flex";
      };
      document.body.appendChild(logoutBtn);
      // Sidebar navigation
      const navs = [
        { id: "nav-dashboard", section: "dashboard-section" },
        { id: "nav-bookings", section: "bookings-section" },
        { id: "nav-users", section: "users-section" },
        { id: "nav-services", section: "services-section" },
        { id: "nav-providers", section: "provider-section" },
        { id: "nav-complaints", section: "complaints-section" },
        { id: "nav-service-requests", section: "service-requests-section" },
        { id: "nav-financial", section: "financial-section" },
      ];
      navs.forEach((nav) => {
        document.getElementById(nav.id).onclick = function (e) {
          e.preventDefault();
          localStorage.setItem("adminActiveSection", nav.section);
          navs.forEach((n) => {
            document.getElementById(n.id).classList.remove("active");
            document.getElementById(n.section).style.display = "none";
          });
          document.getElementById(nav.id).classList.add("active");
          document.getElementById(nav.section).style.display = "";
          // If dashboard, re-render analytics
          if (nav.id === "nav-dashboard") {
            console.log("Dashboard section clicked, re-rendering charts...");
            if (typeof renderAdminAnalytics === "function") {
              console.log("Calling renderAdminAnalytics...");
              renderAdminAnalytics();
            }
            if (typeof waitForChartJS === "function") {
              waitForChartJS(() => {
                console.log("Chart.js ready, re-rendering charts...");
                if (typeof renderRevenueByServiceChart === "function") {
                  console.log("Calling renderRevenueByServiceChart...");
                  renderRevenueByServiceChart();
                }
                if (typeof renderComplaintsStatsChart === "function") {
                  console.log("Calling renderComplaintsStatsChart...");
                  renderComplaintsStatsChart();
                }
              });
            } else {
              console.error("waitForChartJS function not found!");
            }
          }
          // If users section, load users
          if (nav.id === "nav-users") {
            loadUsers();
          }
          // If complaints section, load complaints
          if (nav.id === "nav-complaints") {
            loadComplaints();
          }
          // If services section, load services
          if (nav.id === "nav-services") {
            loadServices();
          }
          // If service requests section, load service requests
          if (nav.id === "nav-service-requests") {
            loadServiceRequests();
          }
          // If financial section, load financial report
          if (nav.id === "nav-financial") {
            loadFinancialReport();
          }
        };
      });
      // Remove local fetchBookings and use the shared fetchBackendBookings from script.js
      // Dashboard widgets and latest bookings
      async function loadDashboard() {
        try {
          // Try to load stats from service requests API first
          try {
            const statsResponse = await fetch(`${API_BASE_URL}/api/admin/stats`);
            if (statsResponse.ok) {
              const stats = await statsResponse.json();
              document.getElementById("total-bookings").textContent = stats.total_bookings || 0;
              document.getElementById("total-earnings").textContent = `R${(stats.this_month_revenue || 0).toFixed(2)}`;
            }
          } catch (error) {
            console.warn("[WARN] Could not load stats from API, using fallback:", error);
          }
          
          const bookings = await fetchBackendBookings();
          const complaints = await fetchBackendComplaints();
          console.log("[DEBUG] Bookings fetched for dashboard:", bookings);
          console.log("[DEBUG] Complaints fetched for dashboard:", complaints);
          
          // Fallback to bookings count if stats API didn't work
          if (!document.getElementById("total-bookings").textContent || document.getElementById("total-bookings").textContent === "0") {
            document.getElementById("total-bookings").textContent = bookings.length;
          }
          
          document.getElementById("total-users").textContent = "1"; // Demo only
          document.getElementById("total-complaints").textContent = complaints.length;
          
          // Fallback earnings calculation if stats API didn't work
          if (document.getElementById("total-earnings").textContent === "R0.00" || !document.getElementById("total-earnings").textContent.includes("R")) {
            const confirmedBookings = bookings.filter((b) => b.status === "confirmed");
            document.getElementById("total-earnings").textContent = "R" + confirmedBookings.length * 500; // Demo: R500 per confirmed booking
          }
          const latest = bookings.slice(-5).reverse();
          const table = document.getElementById("latest-bookings-table");
          const validBookings = latest.filter(
            (b) => b && b.name && b.address && b.date && b.time && b.service
          );
          if (validBookings.length === 0) {
            table.innerHTML =
              '<tr><td colspan="8">No bookings found.</td></tr>';
          } else {
            table.innerHTML = validBookings
              .map(
                (b) => `
            <tr>
              <td>${b.name}</td>
              <td>${b.address}</td>
              <td>${b.date}</td>
              <td>${b.time}</td>
              <td>${b.service}</td>
              <td>${b.details || "-"}</td>
              <td>${b.status || "pending"}</td>
              <td>
                <button type="button" onclick="confirmBooking(event, ${
                  b.id
                })" style="color:#fff;background:#22c55e;border:none;padding:0.4rem 1rem;border-radius:6px;cursor:pointer;">Confirm</button>
                <button type="button" onclick="deleteBooking(event, ${
                  b.id
                })" style="color:#fff;background:#ef4444;border:none;padding:0.4rem 1rem;border-radius:6px;cursor:pointer;">Delete</button>
              </td>
            </tr>
          `
              )
              .join("");
          }
        } catch (error) {
          console.error("[ERROR] Failed to load dashboard bookings:", error);
          const table = document.getElementById("latest-bookings-table");
          table.innerHTML =
            '<tr><td colspan="8" style="color:#ef4444;">Error loading bookings. Please try again.</td></tr>';
        }
      }

      async function loadAllBookings() {
        try {
          const bookings = await fetchBackendBookings();
          console.log("[DEBUG] Bookings fetched for all bookings:", bookings);
          const table = document.getElementById("all-bookings-table");
          const validAllBookings = bookings.filter(
            (b) => b && b.name && b.address && b.date && b.time && b.service
          );
          if (validAllBookings.length === 0) {
            table.innerHTML =
              '<tr><td colspan="8">No bookings found.</td></tr>';
          } else {
            table.innerHTML = validAllBookings
              .map(
                (b) => `
            <tr>
              <td>${b.name}</td>
              <td>${b.address}</td>
              <td>${b.date}</td>
              <td>${b.time}</td>
              <td>${b.service}</td>
              <td>${b.details || "-"}</td>
              <td>${b.status || "pending"}</td>
              <td>
                <button type="button" onclick="confirmBooking(event, ${
                  b.id
                })" style="color:#fff;background:#22c55e;border:none;padding:0.4rem 1rem;border-radius:6px;cursor:pointer;">Confirm</button>
                <button type="button" onclick="deleteBooking(event, ${
                  b.id
                })" style="color:#fff;background:#ef4444;border:none;padding:0.4rem 1rem;border-radius:6px;cursor:pointer;">Delete</button>
              </td>
            </tr>
          `
              )
              .join("");
          }
        } catch (error) {
          console.error("[ERROR] Failed to load all bookings:", error);
          const table = document.getElementById("all-bookings-table");
          table.innerHTML =
            '<tr><td colspan="8" style="color:#ef4444;">Error loading bookings. Please try again.</td></tr>';
        }
      }

      // User management functions
      async function fetchUsers() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/users`);
          if (!response.ok) {
            throw new Error("Failed to fetch users");
          }
          return await response.json();
        } catch (error) {
          console.error("[ERROR] Failed to fetch users:", error);
          throw error;
        }
      }

      async function loadUsers() {
        const table = document.getElementById("users-table");
        const loading = document.getElementById("users-loading");
        const empty = document.getElementById("users-empty");

        try {
          loading.style.display = "block";
          table.style.display = "none";
          empty.style.display = "none";

          const users = await fetchUsers();
          console.log("[DEBUG] Users fetched:", users);

          // Update total users count in dashboard
          document.getElementById("total-users").textContent = users.length;

          if (users.length === 0) {
            loading.style.display = "none";
            empty.style.display = "block";
            return;
          }

          table.innerHTML = users
            .map(
              (user) => `
            <tr style="border-bottom: 1px solid #e5e7eb">
              <td style="padding: 0.75rem">${user.id}</td>
              <td style="padding: 0.75rem">${user.name || "-"}</td>
              <td style="padding: 0.75rem">${user.email || "-"}</td>
              <td style="padding: 0.75rem">${user.phone || "-"}</td>
              <td style="padding: 0.75rem">${user.registered || "-"}</td>
              <td style="padding: 0.75rem">
                <button 
                  onclick="viewUserDetails(${user.id})" 
                  style="
                    background: #3b82f6; 
                    color: #fff; 
                    border: none; 
                    padding: 0.3rem 0.8rem; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    margin-right: 0.5rem;
                    font-size: 0.8rem;
                  "
                >
                  View
                </button>
                <button 
                  onclick="deleteUser(${user.id})" 
                  style="
                    background: #ef4444; 
                    color: #fff; 
                    border: none; 
                    padding: 0.3rem 0.8rem; 
                    border-radius: 4px; 
                    cursor: pointer;
                    font-size: 0.8rem;
                  "
                >
                  Delete
                </button>
              </td>
            </tr>
          `
            )
            .join("");

          loading.style.display = "none";
          table.style.display = "table-row-group";
        } catch (error) {
          console.error("[ERROR] Failed to load users:", error);
          loading.style.display = "none";
          table.innerHTML =
            '<tr><td colspan="6" style="color: #ef4444; text-align: center; padding: 2rem;">Error loading users. Please try again.</td></tr>';
          table.style.display = "table-row-group";
        }
      }

      function filterUsers(searchTerm) {
        const rows = document.querySelectorAll("#users-table tr");
        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          if (text.includes(searchTerm.toLowerCase())) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      async function viewUserDetails(userId) {
        try {
          const users = await fetchUsers();
          const user = users.find((u) => u.id === userId);

          if (user) {
            // Populate the modal with user details
            const userDetailsContent = document.getElementById(
              "user-details-content"
            );
            userDetailsContent.innerHTML = `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">User ID</label>
                    <div style="padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                      ${user.id}
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Full Name</label>
                    <div style="padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                      ${user.name || "Not provided"}
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email Address</label>
                    <div style="padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                      ${user.email || "Not provided"}
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Phone Number</label>
                    <div style="padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                      ${user.phone || "Not provided"}
                    </div>
                  </div>
                </div>
                
                <div>
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Registration Date</label>
                    <div style="padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                      ${user.registered || "Not available"}
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Account Status</label>
                    <div style="padding: 0.75rem; background: #d1fae5; border-radius: 8px; border: 1px solid #a7f3d0; color: #065f46; font-weight: 500;">
                      Active
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Total Bookings</label>
                    <div style="padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                      ${user.totalBookings || 0}
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Last Login</label>
                    <div style="padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                      ${user.lastLogin || "Not available"}
                    </div>
                  </div>
                </div>
              </div>
              
              <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                <h4 style="color: #374151; margin-bottom: 1rem;">Recent Activity</h4>
                <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; border: 1px solid #e5e7eb;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: #374151;">Account created</span>
                    <span style="color: #6b7280; font-size: 0.9rem;">${
                      user.registered || "Unknown date"
                    }</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: #374151;">Profile completed</span>
                    <span style="color: #6b7280; font-size: 0.9rem;">${
                      user.registered || "Unknown date"
                    }</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #374151;">First booking made</span>
                    <span style="color: #6b7280; font-size: 0.9rem;">Not yet</span>
                  </div>
                </div>
              </div>
            `;

            // Update modal title
            document.getElementById(
              "user-modal-title"
            ).textContent = `User Details - ${user.name || "Unknown User"}`;

            // Store user ID for edit functionality
            document
              .getElementById("edit-user-btn")
              .setAttribute("data-user-id", userId);

            // Show the modal
            document.getElementById("user-details-modal").style.display =
              "flex";
          } else {
            alert("User not found!");
          }
        } catch (error) {
          console.error("[ERROR] Failed to load user details:", error);
          alert("Failed to load user details. Please try again.");
        }
      }

      async function openUserEditModal(userId) {
        try {
          const users = await fetchUsers();
          const user = users.find((u) => u.id === userId);

          if (user) {
            // Populate the edit form with user data
            document.getElementById("edit-user-name").value = user.name || "";
            document.getElementById("edit-user-email").value = user.email || "";
            document.getElementById("edit-user-phone").value = user.phone || "";
            document.getElementById("edit-user-status").value =
              user.status || "active";
            document.getElementById("edit-user-role").value =
              user.role || "customer";
            document.getElementById("edit-user-address").value =
              user.address || "";

            // Store the user ID for saving
            document
              .getElementById("user-edit-form")
              .setAttribute("data-user-id", userId);

            // Update modal title
            document.getElementById(
              "user-edit-modal-title"
            ).textContent = `Edit User - ${user.name || "Unknown User"}`;

            // Close the details modal and open the edit modal
            document.getElementById("user-details-modal").style.display =
              "none";
            document.getElementById("user-edit-modal").style.display = "flex";
          } else {
            alert("User not found!");
          }
        } catch (error) {
          console.error("[ERROR] Failed to load user for editing:", error);
          alert("Failed to load user data for editing. Please try again.");
        }
      }

      async function deleteUser(userId) {
        if (!confirm("Are you sure you want to delete this user?")) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/api/users/${userId}`, {
            method: "DELETE",
          });

          if (response.ok) {
            alert("User deleted successfully!");
            loadUsers(); // Reload the users list
          } else {
            const errorData = await response.json();
            alert(
              `Failed to delete user: ${errorData.error || "Unknown error"}`
            );
          }
        } catch (error) {
          console.error("[ERROR] Failed to delete user:", error);
          alert("Failed to delete user. Please try again.");
        }
      }

      // Add event listeners for user management
      document.addEventListener("DOMContentLoaded", function () {
        const userSearch = document.getElementById("user-search");
        const refreshUsersBtn = document.getElementById("refresh-users-btn");

        if (userSearch) {
          userSearch.addEventListener("input", function () {
            filterUsers(this.value);
          });
        }

        if (refreshUsersBtn) {
          refreshUsersBtn.addEventListener("click", loadUsers);
        }
      });

      // Provider management functions
      async function fetchProviders() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/providers`);
          if (!response.ok) {
            throw new Error("Failed to fetch providers");
          }
          return await response.json();
        } catch (error) {
          console.error("[ERROR] Failed to fetch providers:", error);
          throw error;
        }
      }

      async function loadProviders() {
        const table = document.getElementById("provider-table");
        const loading = document.getElementById("providers-loading");
        const empty = document.getElementById("providers-empty");

        try {
          if (loading) loading.style.display = "block";
          if (table) table.style.display = "none";
          if (empty) empty.style.display = "none";

          const providers = await fetchProviders();
          console.log("[DEBUG] Providers fetched:", providers);
          console.log("[DEBUG] First provider name:", providers[0]?.name);

          // Update statistics
          updateProviderStats(providers);

          if (providers.length === 0) {
            if (loading) loading.style.display = "none";
            if (empty) empty.style.display = "block";
            return;
          }

          table.innerHTML = providers
            .map(
              (provider) => `
            <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor=''">
              <td style="padding: 1rem; font-weight: 500; color: #111827;">${
                provider.name || "-"
              }</td>
              <td style="padding: 1rem;">
                <span style="
                  background: #e0f2fe; 
                  color: #0369a1; 
                  padding: 0.25rem 0.75rem; 
                  border-radius: 20px; 
                  font-size: 0.8rem; 
                  font-weight: 500;
                ">${provider.service_type || "-"}</span>
              </td>
              <td style="padding: 1rem; color: #6b7280;">${
                provider.phone || "-"
              }</td>
              <td style="padding: 1rem; color: #6b7280;">${
                provider.email || "-"
              }</td>
              <td style="padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: #fbbf24; font-size: 1.1rem;">★</span>
                  <span style="font-weight: 600;">${provider.rating || 0}</span>
                  <span style="color: #6b7280; font-size: 0.9rem;">(${
                    provider.total_bookings || 0
                  } bookings)</span>
                </div>
              </td>
              <td style="padding: 1rem;">
                <span style="
                  background: ${
                    provider.status === "active"
                      ? "#dcfce7"
                      : provider.status === "inactive"
                      ? "#fef3c7"
                      : "#fee2e2"
                  }; 
                  color: ${
                    provider.status === "active"
                      ? "#166534"
                      : provider.status === "inactive"
                      ? "#92400e"
                      : "#dc2626"
                  }; 
                  padding: 0.25rem 0.75rem; 
                  border-radius: 20px; 
                  font-size: 0.8rem; 
                  font-weight: 500;
                  text-transform: capitalize;
                ">${provider.status || "active"}</span>
              </td>
              <td style="padding: 1rem; text-align: center;">
                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                  <button 
                    onclick="viewProviderDetails(${provider.id})" 
                    style="
                      background: #3b82f6; 
                      color: #fff; 
                      border: none; 
                      padding: 0.4rem 0.8rem; 
                      border-radius: 6px; 
                      cursor: pointer; 
                      font-size: 0.8rem;
                      transition: background-color 0.2s;
                    "
                    onmouseover="this.style.backgroundColor='#2563eb'"
                    onmouseout="this.style.backgroundColor='#3b82f6'"
                    title="View Details"
                  >
                    👁️ View
                  </button>
                  <button 
                    onclick="editProvider(${provider.id})" 
                    style="
                      background: #f59e0b; 
                      color: #fff; 
                      border: none; 
                      padding: 0.4rem 0.8rem; 
                      border-radius: 6px; 
                      cursor: pointer; 
                      font-size: 0.8rem;
                      transition: background-color 0.2s;
                    "
                    onmouseover="this.style.backgroundColor='#d97706'"
                    onmouseout="this.style.backgroundColor='#f59e0b'"
                    title="Edit Provider"
                  >
                    ✏️ Edit
                  </button>
                  <button 
                    onclick="deleteProvider(${provider.id})" 
                    style="
                      background: #ef4444; 
                      color: #fff; 
                      border: none; 
                      padding: 0.4rem 0.8rem; 
                      border-radius: 6px; 
                      cursor: pointer;
                      font-size: 0.8rem;
                      transition: background-color 0.2s;
                    "
                    onmouseover="this.style.backgroundColor='#dc2626'"
                    onmouseout="this.style.backgroundColor='#ef4444'"
                    title="Delete Provider"
                  >
                    🗑️ Delete
                  </button>
                </div>
              </td>
            </tr>
          `
            )
            .join("");

          if (loading) loading.style.display = "none";
          if (table) table.style.display = "table-row-group";
        } catch (error) {
          console.error("[ERROR] Failed to load providers:", error);
          if (loading) loading.style.display = "none";
          if (table) {
            table.innerHTML =
              '<tr><td colspan="7" style="color: #ef4444; text-align: center; padding: 2rem;">Error loading providers. Please try again.</td></tr>';
            table.style.display = "table-row-group";
          }
        }
      }

      function updateProviderStats(providers) {
        const totalElement = document.getElementById("providers-total");
        const activeElement = document.getElementById("providers-active");
        const avgRatingElement = document.getElementById(
          "providers-avg-rating"
        );

        if (totalElement) totalElement.textContent = providers.length;

        if (activeElement) {
          const activeCount = providers.filter(
            (p) => p.status === "active"
          ).length;
          activeElement.textContent = activeCount;
        }

        if (avgRatingElement) {
          const totalRating = providers.reduce(
            (sum, p) => sum + (p.rating || 0),
            0
          );
          const avgRating =
            providers.length > 0
              ? (totalRating / providers.length).toFixed(1)
              : "0.0";
          avgRatingElement.textContent = avgRating;
        }
      }

      async function filterProviders() {
        const statusFilter = document.getElementById(
          "provider-status-filter"
        ).value;
        const serviceFilter = document.getElementById(
          "provider-service-filter"
        ).value;

        try {
          const allProviders = await fetchProviders();
          let filteredProviders = allProviders;

          // Filter by status
          if (statusFilter !== "all") {
            filteredProviders = filteredProviders.filter(
              (p) => p.status === statusFilter
            );
          }

          // Filter by service type
          if (serviceFilter !== "all") {
            filteredProviders = filteredProviders.filter(
              (p) => p.service_type === serviceFilter
            );
          }

          // Update the table with filtered results
          const table = document.getElementById("provider-table");
          if (filteredProviders.length === 0) {
            table.innerHTML =
              '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">No providers match the selected filters.</td></tr>';
          } else {
            // Reuse the same rendering logic as loadProviders
            table.innerHTML = filteredProviders
              .map(
                (provider) => `
               <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor=''">
                 <td style="padding: 1rem; font-weight: 500; color: #111827;">${
                   provider.name || "-"
                 }</td>
                <td style="padding: 1rem;">
                  <span style="
                    background: #10169f; 
                    color: #0369a1; 
                    padding: 0.25rem 0.75rem; 
                    border-radius: 20px; 
                    font-size: 0.8rem; 
                    font-weight: 500;
                  ">${provider.service_type || "-"}</span>
                </td>
                <td style="padding: 1rem; color: #6b7280;">${
                  provider.phone || "-"
                }</td>
                <td style="padding: 1rem; color: #6b7280;">${
                  provider.email || "-"
                }</td>
                <td style="padding: 1rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: #fbbf24; font-size: 1.1rem;">★</span>
                    <span style="font-weight: 600;">${
                      provider.rating || 0
                    }</span>
                    <span style="color: #6b7280; font-size: 0.9rem;">(${
                      provider.total_bookings || 0
                    } bookings)</span>
                  </div>
                </td>
                <td style="padding: 1rem;">
                  <span style="
                    background: ${
                      provider.status === "active"
                        ? "#dcfce7"
                        : provider.status === "inactive"
                        ? "#fef3c7"
                        : "#fee2e2"
                    }; 
                    color: ${
                      provider.status === "active"
                        ? "#166534"
                        : provider.status === "inactive"
                        ? "#92400e"
                        : "#dc2626"
                    }; 
                    padding: 0.25rem 0.75rem; 
                    border-radius: 20px; 
                    font-size: 0.8rem; 
                    font-weight: 500;
                    text-transform: capitalize;
                  ">${provider.status || "active"}</span>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <div style="display: flex; gap: 0.5rem; justify-content: center;">
                    <button 
                      onclick="viewProviderDetails(${provider.id})" 
                      style="
                        background: #3b82f6; 
                        color: #fff; 
                        border: none; 
                        padding: 0.4rem 0.8rem; 
                        border-radius: 6px; 
                        cursor: pointer; 
                        font-size: 0.8rem;
                        transition: background-color 0.2s;
                      "
                      onmouseover="this.style.backgroundColor='#2563eb'"
                      onmouseout="this.style.backgroundColor='#3b82f6'"
                      title="View Details"
                    >
                      👁️ View
                    </button>
                    <button 
                      onclick="editProvider(${provider.id})" 
                      style="
                        background: #f59e0b; 
                        color: #fff; 
                        border: none; 
                        padding: 0.4rem 0.8rem; 
                        border-radius: 6px; 
                        cursor: pointer; 
                        font-size: 0.8rem;
                        transition: background-color 0.2s;
                      "
                      onmouseover="this.style.backgroundColor='#d97706'"
                      onmouseout="this.style.backgroundColor='#f59e0b'"
                      title="Edit Provider"
                    >
                      ✏️ Edit
                    </button>
                    <button 
                      onclick="deleteProvider(${provider.id})" 
                      style="
                        background: #ef4444; 
                        color: #fff; 
                        border: none; 
                        padding: 0.4rem 0.8rem; 
                        border-radius: 6px; 
                        cursor: pointer;
                        font-size: 0.8rem;
                        transition: background-color 0.2s;
                      "
                      onmouseover="this.style.backgroundColor='#dc2626'"
                      onmouseout="this.style.backgroundColor='#ef4444'"
                      title="Delete Provider"
                    >
                      🗑️ Delete
                    </button>
                  </div>
                </td>
              </tr>
            `
              )
              .join("");
          }
        } catch (error) {
          console.error("[ERROR] Failed to filter providers:", error);
        }
      }

      async function addProvider(providerData) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/providers`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(providerData),
          });

          if (response.ok) {
            const result = await response.json();
            alert("Provider added successfully!");
            loadProviders();
            return result;
          } else {
            const errorData = await response.json();
            alert(
              `Failed to add provider: ${errorData.error || "Unknown error"}`
            );
            return null;
          }
        } catch (error) {
          console.error("[ERROR] Failed to add provider:", error);
          alert("Failed to add provider. Please try again.");
          return null;
        }
      }

      async function deleteProvider(providerId) {
        if (!confirm("Are you sure you want to delete this provider?")) {
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE_URL}/api/providers/${providerId}`,
            {
              method: "DELETE",
            }
          );

          if (response.ok) {
            alert("Provider deleted successfully!");
            loadProviders();
          } else {
            const errorData = await response.json();
            alert(
              `Failed to delete provider: ${errorData.error || "Unknown error"}`
            );
          }
        } catch (error) {
          console.error("[ERROR] Failed to delete provider:", error);
          alert("Failed to delete provider. Please try again.");
        }
      }

      async function viewProviderDetails(providerId) {
        try {
          const providers = await fetchProviders();
          const provider = providers.find((p) => p.id === providerId);

          if (!provider) {
            alert("Provider not found");
            return;
          }

          const detailsContent = document.getElementById(
            "provider-details-content"
          );
          detailsContent.innerHTML = `
            <div style="display: grid; gap: 1rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Name:</span>
                <span style="color: #6b7280;">${provider.name}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Service Type:</span>
                <span style="background: #e0f2fe; color: #0369a1; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">${
                  provider.service_type
                }</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Phone:</span>
                <span style="color: #6b7280;">${provider.phone}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Email:</span>
                <span style="color: #6b7280;">${provider.email}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Address:</span>
                <span style="color: #6b7280;">${
                  provider.address || "Not provided"
                }</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Experience:</span>
                <span style="color: #6b7280;">${
                  provider.experience_years
                } years</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Hourly Rate:</span>
                <span style="color: #6b7280;">R${provider.hourly_rate}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Rating:</span>
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: #fbbf24;">★</span>
                  <span style="color: #6b7280;">${provider.rating}/5</span>
                </span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Total Bookings:</span>
                <span style="color: #6b7280;">${provider.total_bookings}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Status:</span>
                <span style="
                  background: ${
                    provider.status === "active"
                      ? "#dcfce7"
                      : provider.status === "inactive"
                      ? "#fef3c7"
                      : "#fee2e2"
                  }; 
                  color: ${
                    provider.status === "active"
                      ? "#166534"
                      : provider.status === "inactive"
                      ? "#92400e"
                      : "#dc2626"
                  }; 
                  padding: 0.25rem 0.75rem; 
                  border-radius: 20px; 
                  font-size: 0.8rem; 
                  font-weight: 500;
                  text-transform: capitalize;
                ">${provider.status}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <span style="font-weight: 600; color: #374151;">Registered:</span>
                <span style="color: #6b7280;">${provider.registered}</span>
              </div>
            </div>
          `;

          // Set the provider ID for the edit button
          document
            .getElementById("edit-provider-btn")
            .setAttribute("data-provider-id", providerId);

          // Show the modal
          document.getElementById("provider-details-modal").style.display =
            "flex";
        } catch (error) {
          console.error("[ERROR] Failed to load provider details:", error);
          alert("Failed to load provider details. Please try again.");
        }
      }

      async function editProvider(providerId) {
        try {
          const providers = await fetchProviders();
          const provider = providers.find((p) => p.id === providerId);

          if (!provider) {
            alert("Provider not found");
            return;
          }

          // Populate the edit form
          document.getElementById("edit-provider-name").value = provider.name;
          document.getElementById("edit-provider-service").value =
            provider.service_type;
          document.getElementById("edit-provider-phone").value = provider.phone;
          document.getElementById("edit-provider-email").value = provider.email;
          document.getElementById("edit-provider-address").value =
            provider.address || "";
          document.getElementById("edit-provider-experience").value =
            provider.experience_years;
          document.getElementById("edit-provider-rate").value =
            provider.hourly_rate;
          document.getElementById("edit-provider-rating").value =
            provider.rating;
          document.getElementById("edit-provider-bookings").value =
            provider.total_bookings;
          document.getElementById("edit-provider-status").value =
            provider.status;

          // Set the provider ID for the form
          document
            .getElementById("provider-edit-form")
            .setAttribute("data-provider-id", providerId);

          // Show the modal
          document.getElementById("provider-edit-modal").style.display = "flex";
        } catch (error) {
          console.error("[ERROR] Failed to load provider for editing:", error);
          alert("Failed to load provider details. Please try again.");
        }
      }

      // Complaints management functions
      async function fetchComplaints() {
        return await fetchBackendComplaints();
      }

      async function loadComplaints() {
        const table = document.getElementById("complaints-table");
        const loading = document.getElementById("complaints-loading");
        const empty = document.getElementById("complaints-empty");

        try {
          loading.style.display = "block";
          table.style.display = "none";
          empty.style.display = "none";

          const complaints = await fetchComplaints();
          console.log("[DEBUG] Complaints fetched:", complaints);

          if (complaints.length === 0) {
            loading.style.display = "none";
            empty.style.display = "block";
            return;
          }

          table.innerHTML = complaints
            .map(
              (complaint) => `
            <tr style="border-bottom: 1px solid #e5e7eb">
              <td style="padding: 0.75rem">${complaint.id}</td>
              <td style="padding: 0.75rem">${complaint.name || "-"}</td>
              <td style="padding: 0.75rem">${
                complaint.type.replace(/-/g, " ") || "-"
              }</td>
              <td style="padding: 0.75rem">${complaint.title || "-"}</td>
              <td style="padding: 0.75rem">
                <span style="
                  padding: 0.25rem 0.5rem;
                  border-radius: 4px;
                  font-size: 0.75rem;
                  font-weight: 500;
                  background: ${
                    complaint.status === "pending"
                      ? "#fef3c7"
                      : complaint.status === "in-progress"
                      ? "#dbeafe"
                      : complaint.status === "resolved"
                      ? "#d1fae5"
                      : "#f3f4f6"
                  };
                  color: ${
                    complaint.status === "pending"
                      ? "#92400e"
                      : complaint.status === "in-progress"
                      ? "#1e40af"
                      : complaint.status === "resolved"
                      ? "#065f46"
                      : "#374151"
                  };
                ">
                  ${
                    complaint.status.charAt(0).toUpperCase() +
                    complaint.status.slice(1)
                  }
                </span>
              </td>
              <td style="padding: 0.75rem">${complaint.date || "-"}</td>
              <td style="padding: 0.75rem">
                ${
                  complaint.urgency_level
                    ? `<span style="
                  padding: 0.25rem 0.5rem;
                  border-radius: 4px;
                  font-size: 0.75rem;
                  font-weight: 500;
                  background: ${
                    complaint.urgency_level === "low"
                      ? "#d1fae5"
                      : complaint.urgency_level === "medium"
                      ? "#fef3c7"
                      : complaint.urgency_level === "high"
                      ? "#fed7d7"
                      : "#fecaca"
                  };
                  color: ${
                    complaint.urgency_level === "low"
                      ? "#065f46"
                      : complaint.urgency_level === "medium"
                      ? "#92400e"
                      : complaint.urgency_level === "high"
                      ? "#991b1b"
                      : "#7f1d1d"
                  };
                ">${complaint.urgency_level}</span>`
                    : "-"
                }
              </td>
              <td style="padding: 0.75rem">
                <button 
                  onclick="viewComplaintDetails(${complaint.id})" 
                  style="
                    background: #3b82f6; 
                    color: #fff; 
                    border: none; 
                    padding: 0.3rem 0.8rem; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    margin-right: 0.5rem;
                    font-size: 0.8rem;
                  "
                >
                  View
                </button>
                <button 
                  onclick="updateComplaintStatus(${complaint.id})" 
                  style="
                    background: #22c55e; 
                    color: #fff; 
                    border: none; 
                    padding: 0.3rem 0.8rem; 
                    border-radius: 4px; 
                    cursor: pointer;
                    font-size: 0.8rem;
                  "
                >
                  Update
                </button>
              </td>
            </tr>
          `
            )
            .join("");

          loading.style.display = "none";
          table.style.display = "table-row-group";
        } catch (error) {
          console.error("[ERROR] Failed to load complaints:", error);
          loading.style.display = "none";
          table.innerHTML =
            '<tr><td colspan="8" style="color: #ef4444; text-align: center; padding: 2rem;">Error loading complaints. Please try again.</td></tr>';
          table.style.display = "table-row-group";
        }
      }

      function viewComplaintDetails(complaintId) {
        // For now, just show an alert. You can expand this to show a modal with more details
        alert(`Viewing details for complaint ID: ${complaintId}`);
      }

      async function updateComplaintStatus(complaintId) {
        const newStatus = prompt(
          "Enter new status (pending/in-progress/resolved/closed):"
        );
        if (!newStatus) return;

        try {
          const response = await fetch(
            `${API_BASE_URL}/api/complaints/${complaintId}`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: newStatus.toLowerCase() }),
            }
          );

          if (response.ok) {
            alert("Complaint status updated successfully!");
            loadComplaints();
          } else {
            alert("Failed to update complaint status.");
          }
        } catch (error) {
          console.error("[ERROR] Failed to update complaint status:", error);
          alert("Failed to update complaint status. Please try again.");
        }
      }

      // Add event listeners for complaints management
      document.addEventListener("DOMContentLoaded", function () {
        const refreshComplaintsBtn = document.getElementById(
          "refresh-complaints-btn"
        );
        const statusFilter = document.getElementById("complaint-status-filter");
        const typeFilter = document.getElementById("complaint-type-filter");

        if (refreshComplaintsBtn) {
          refreshComplaintsBtn.addEventListener("click", loadComplaints);
        }

        if (statusFilter) {
          statusFilter.addEventListener("change", filterComplaints);
        }

        if (typeFilter) {
          typeFilter.addEventListener("change", filterComplaints);
        }
      });

      function filterComplaints() {
        const statusFilter = document.getElementById(
          "complaint-status-filter"
        ).value;
        const typeFilter = document.getElementById(
          "complaint-type-filter"
        ).value;

        const complaintRows = document.querySelectorAll("#complaints-table tr");

        complaintRows.forEach((row) => {
          const status = row
            .querySelector("td:nth-child(5) span")
            .textContent.toLowerCase();
          const type = row
            .querySelector("td:nth-child(3)")
            .textContent.toLowerCase();

          const statusMatch =
            statusFilter === "all" || status.includes(statusFilter);
          const typeMatch = typeFilter === "all" || type.includes(typeFilter);

          if (statusMatch && typeMatch) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      // Services management functions
      const servicesData = [
        {
          id: 1,
          name: "House Cleaning",
          icon: "🧹",
          description: "Professional house cleaning services",
          status: "active",
          price: "R200-500",
          bookings: 45,
          rating: 4.8,
          category: "Cleaning",
        },
        {
          id: 2,
          name: "Plumbing",
          icon: "🔧",
          description: "Emergency and routine plumbing services",
          status: "active",
          price: "R300-800",
          bookings: 32,
          rating: 4.6,
          category: "Repair",
        },
        {
          id: 3,
          name: "Electrical",
          icon: "⚡",
          description: "Electrical installation and repair",
          status: "active",
          price: "R400-1000",
          bookings: 28,
          rating: 4.7,
          category: "Repair",
        },
        {
          id: 4,
          name: "Gardening",
          icon: "🌿",
          description: "Landscaping and garden maintenance",
          status: "active",
          price: "R250-600",
          bookings: 19,
          rating: 4.5,
          category: "Outdoor",
        },
        {
          id: 5,
          name: "Handyman",
          icon: "🔨",
          description: "General handyman services",
          status: "active",
          price: "R200-500",
          bookings: 38,
          rating: 4.4,
          category: "Repair",
        },
        {
          id: 6,
          name: "Locksmith",
          icon: "🔐",
          description: "Emergency locksmith services",
          status: "active",
          price: "R150-400",
          bookings: 15,
          rating: 4.9,
          category: "Security",
        },
        {
          id: 7,
          name: "Air Conditioning",
          icon: "❄️",
          description: "AC installation and maintenance",
          status: "active",
          price: "R500-1200",
          bookings: 22,
          rating: 4.6,
          category: "HVAC",
        },
        {
          id: 8,
          name: "Pest Control",
          icon: "🐜",
          description: "Professional pest control services",
          status: "maintenance",
          price: "R300-700",
          bookings: 12,
          rating: 4.3,
          category: "Health",
        },
      ];

      async function loadServices() {
        const grid = document.getElementById("services-grid");
        const loading = document.getElementById("services-loading");
        const empty = document.getElementById("services-empty");

        try {
          loading.style.display = "block";
          grid.style.display = "none";
          empty.style.display = "none";

          // Simulate API call delay
          await new Promise((resolve) => setTimeout(resolve, 500));

          console.log("[DEBUG] Services loaded:", servicesData);

          if (servicesData.length === 0) {
            loading.style.display = "none";
            empty.style.display = "block";
            return;
          }

          grid.innerHTML = servicesData
            .map(
              (service) => `
            <div style="
              background: #fff;
              border-radius: 12px;
              padding: 1.5rem;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              border: 1px solid #e5e7eb;
            ">
              <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                <div style="font-size: 2rem; margin-right: 1rem;">${
                  service.icon
                }</div>
                <div style="flex: 1;">
                  <h3 style="margin: 0; color: #111; font-size: 1.2rem;">${
                    service.name
                  }</h3>
                  <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.9rem;">${
                    service.category
                  }</p>
                </div>
                <span style="
                  padding: 0.25rem 0.5rem;
                  border-radius: 4px;
                  font-size: 0.75rem;
                  font-weight: 500;
                  background: ${
                    service.status === "active"
                      ? "#d1fae5"
                      : service.status === "maintenance"
                      ? "#fef3c7"
                      : "#f3f4f6"
                  };
                  color: ${
                    service.status === "active"
                      ? "#065f46"
                      : service.status === "maintenance"
                      ? "#92400e"
                      : "#374151"
                  };
                ">
                  ${
                    service.status.charAt(0).toUpperCase() +
                    service.status.slice(1)
                  }
                </span>
              </div>
              
              <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">${
                service.description
              }</p>
              
              <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 0.9rem;">
                <div>
                  <strong>Price:</strong> ${service.price}
                </div>
                <div>
                  <strong>Bookings:</strong> ${service.bookings}
                </div>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center;">
                  <span style="color: #fbbf24; margin-right: 0.25rem;">★</span>
                  <span style="font-size: 0.9rem;">${service.rating}</span>
                </div>
                <div style="font-size: 0.9rem; color: #666;">
                  ID: ${service.id}
                </div>
              </div>
              
              <div style="display: flex; gap: 0.5rem;">
                <button 
                  onclick="editService(${service.id})" 
                  style="
                    background: #3b82f6; 
                    color: #fff; 
                    border: none; 
                    padding: 0.5rem 1rem; 
                    border-radius: 6px; 
                    cursor: pointer; 
                    font-size: 0.8rem;
                    flex: 1;
                  "
                >
                  Edit
                </button>
                <button 
                  onclick="toggleServiceStatus(${service.id})" 
                  style="
                    background: ${
                      service.status === "active" ? "#ef4444" : "#22c55e"
                    }; 
                    color: #fff; 
                    border: none; 
                    padding: 0.5rem 1rem; 
                    border-radius: 6px; 
                    cursor: pointer; 
                    font-size: 0.8rem;
                    flex: 1;
                  "
                >
                  ${service.status === "active" ? "Deactivate" : "Activate"}
                </button>
              </div>
            </div>
          `
            )
            .join("");

          loading.style.display = "none";
          grid.style.display = "grid";

          // Update statistics
          updateServicesStats();
        } catch (error) {
          console.error("[ERROR] Failed to load services:", error);
          loading.style.display = "none";
          empty.style.display = "block";
        }
      }

      function updateServicesStats() {
        const totalServices = servicesData.length;
        const activeServices = servicesData.filter(
          (s) => s.status === "active"
        ).length;
        const totalBookings = servicesData.reduce(
          (sum, s) => sum + s.bookings,
          0
        );

        document.querySelector(
          "#services-section .admin-widget:nth-child(1) div"
        ).textContent = totalServices;
        document.querySelector(
          "#services-section .admin-widget:nth-child(2) div"
        ).textContent = activeServices;
        document.getElementById("services-total-bookings").textContent =
          totalBookings;
      }

      function editService(serviceId) {
        const service = servicesData.find((s) => s.id === serviceId);
        if (service) {
          // Populate the modal with service data
          document.getElementById("edit-service-name").value = service.name;
          document.getElementById("edit-service-category").value =
            service.category;
          document.getElementById("edit-service-description").value =
            service.description;
          document.getElementById("edit-service-price").value = service.price;
          document.getElementById("edit-service-status").value = service.status;
          document.getElementById("edit-service-icon").value = service.icon;

          // Store the service ID for saving
          document
            .getElementById("service-edit-form")
            .setAttribute("data-service-id", serviceId);

          // Show the modal
          document.getElementById("service-edit-modal").style.display = "flex";
        }
      }

      function toggleServiceStatus(serviceId) {
        const service = servicesData.find((s) => s.id === serviceId);
        if (service) {
          const newStatus = service.status === "active" ? "inactive" : "active";
          service.status = newStatus;
          loadServices(); // Reload to update the display
          alert(
            `Service ${service.name} ${
              newStatus === "active" ? "activated" : "deactivated"
            } successfully!`
          );
        }
      }

      function filterServices() {
        const statusFilter = document.getElementById(
          "service-status-filter"
        ).value;
        const serviceCards = document.querySelectorAll("#services-grid > div");

        serviceCards.forEach((card) => {
          const status = card.querySelector("span").textContent.toLowerCase();
          const statusMatch =
            statusFilter === "all" || status.includes(statusFilter);

          if (statusMatch) {
            card.style.display = "block";
          } else {
            card.style.display = "none";
          }
        });
      }

      // Add event listeners for services management
      document.addEventListener("DOMContentLoaded", function () {
        const refreshServicesBtn = document.getElementById(
          "refresh-services-btn"
        );
        const statusFilter = document.getElementById("service-status-filter");
        const addServiceBtn = document.getElementById("add-service-btn");

        if (refreshServicesBtn) {
          refreshServicesBtn.addEventListener("click", loadServices);
        }

        if (statusFilter) {
          statusFilter.addEventListener("change", filterServices);
        }

        if (addServiceBtn) {
          addServiceBtn.addEventListener("click", function () {
            alert(
              "Add New Service\n\nThis would open a modal to add a new service."
            );
          });
        }

        // Service edit modal event listeners
        const closeServiceModal = document.getElementById(
          "close-service-modal"
        );
        const cancelServiceEdit = document.getElementById(
          "cancel-service-edit"
        );
        const serviceEditForm = document.getElementById("service-edit-form");
        const serviceEditModal = document.getElementById("service-edit-modal");

        if (closeServiceModal) {
          closeServiceModal.addEventListener("click", function () {
            serviceEditModal.style.display = "none";
          });
        }

        if (cancelServiceEdit) {
          cancelServiceEdit.addEventListener("click", function () {
            serviceEditModal.style.display = "none";
          });
        }

        if (serviceEditForm) {
          serviceEditForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const serviceId = parseInt(this.getAttribute("data-service-id"));
            const service = servicesData.find((s) => s.id === serviceId);

            if (service) {
              // Update the service data
              service.name = document.getElementById("edit-service-name").value;
              service.category = document.getElementById(
                "edit-service-category"
              ).value;
              service.description = document.getElementById(
                "edit-service-description"
              ).value;
              service.price =
                document.getElementById("edit-service-price").value;
              service.status = document.getElementById(
                "edit-service-status"
              ).value;
              service.icon = document.getElementById("edit-service-icon").value;

              // Close the modal
              serviceEditModal.style.display = "none";

              // Reload services to show updated data
              loadServices();

              // Show success message
              alert(`Service "${service.name}" updated successfully!`);
            }
          });
        }

        // Close modal when clicking outside
        if (serviceEditModal) {
          serviceEditModal.addEventListener("click", function (e) {
            if (e.target === this) {
              this.style.display = "none";
            }
          });
        }

        // User details modal event listeners
        const closeUserModal = document.getElementById("close-user-modal");
        const closeUserDetails = document.getElementById("close-user-details");
        const editUserBtn = document.getElementById("edit-user-btn");
        const userDetailsModal = document.getElementById("user-details-modal");

        if (closeUserModal) {
          closeUserModal.addEventListener("click", function () {
            userDetailsModal.style.display = "none";
          });
        }

        if (closeUserDetails) {
          closeUserDetails.addEventListener("click", function () {
            userDetailsModal.style.display = "none";
          });
        }

        if (editUserBtn) {
          editUserBtn.addEventListener("click", function () {
            const userId = parseInt(this.getAttribute("data-user-id"));
            openUserEditModal(userId);
          });
        }

        // Close user modal when clicking outside
        if (userDetailsModal) {
          userDetailsModal.addEventListener("click", function (e) {
            if (e.target === this) {
              this.style.display = "none";
            }
          });
        }

        // User edit modal event listeners
        const closeUserEditModal = document.getElementById(
          "close-user-edit-modal"
        );
        const cancelUserEdit = document.getElementById("cancel-user-edit");
        const userEditForm = document.getElementById("user-edit-form");
        const userEditModal = document.getElementById("user-edit-modal");

        if (closeUserEditModal) {
          closeUserEditModal.addEventListener("click", function () {
            userEditModal.style.display = "none";
          });
        }

        if (cancelUserEdit) {
          cancelUserEdit.addEventListener("click", function () {
            userEditModal.style.display = "none";
          });
        }

        if (userEditForm) {
          userEditForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const userId = parseInt(this.getAttribute("data-user-id"));

            // Get form data
            const updatedUser = {
              name: document.getElementById("edit-user-name").value,
              email: document.getElementById("edit-user-email").value,
              phone: document.getElementById("edit-user-phone").value,
              status: document.getElementById("edit-user-status").value,
              role: document.getElementById("edit-user-role").value,
              address: document.getElementById("edit-user-address").value,
            };

            try {
              // Send the data to the backend
              const response = await fetch(
                `${API_BASE_URL}/api/users/${userId}`,
                {
                  method: "PATCH",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    name: updatedUser.name,
                    email: updatedUser.email,
                    phone: updatedUser.phone,
                  }),
                }
              );

              if (response.ok) {
                // Close the modal
                userEditModal.style.display = "none";

                // Show success message
                alert(`User "${updatedUser.name}" updated successfully!`);

                // Reload users to show updated data
                loadUsers();
              } else {
                const errorData = await response.json();
                alert(
                  `Failed to update user: ${errorData.error || "Unknown error"}`
                );
              }
            } catch (error) {
              console.error("[ERROR] Failed to update user:", error);
              alert("Failed to update user. Please try again.");
            }
          });
        }

        // Close user edit modal when clicking outside
        if (userEditModal) {
          userEditModal.addEventListener("click", function (e) {
            if (e.target === this) {
              this.style.display = "none";
            }
          });
        }

        // Provider modal event listeners
        const addProviderBtn = document.getElementById("add-provider-btn");
        const closeProviderModal = document.getElementById(
          "close-provider-modal"
        );
        const providerForm = document.getElementById("provider-form");
        const providerModal = document.getElementById("provider-modal");
        const refreshProvidersBtn = document.getElementById(
          "refresh-providers-btn"
        );
        const providerStatusFilter = document.getElementById(
          "provider-status-filter"
        );
        const providerServiceFilter = document.getElementById(
          "provider-service-filter"
        );

        // Provider details modal elements
        const closeProviderDetailsModal = document.getElementById(
          "close-provider-details-modal"
        );
        const closeProviderDetails = document.getElementById(
          "close-provider-details"
        );
        const editProviderBtn = document.getElementById("edit-provider-btn");
        const providerDetailsModal = document.getElementById(
          "provider-details-modal"
        );

        // Provider edit modal elements
        const closeProviderEditModal = document.getElementById(
          "close-provider-edit-modal"
        );
        const cancelProviderEdit = document.getElementById(
          "cancel-provider-edit"
        );
        const providerEditForm = document.getElementById("provider-edit-form");
        const providerEditModal = document.getElementById(
          "provider-edit-modal"
        );

        if (addProviderBtn) {
          addProviderBtn.addEventListener("click", function () {
            providerModal.style.display = "flex";
          });
        }

        if (closeProviderModal) {
          closeProviderModal.addEventListener("click", function () {
            providerModal.style.display = "none";
          });
        }

        if (refreshProvidersBtn) {
          refreshProvidersBtn.addEventListener("click", loadProviders);
        }

        if (providerStatusFilter) {
          providerStatusFilter.addEventListener("change", filterProviders);
        }

        if (providerServiceFilter) {
          providerServiceFilter.addEventListener("change", filterProviders);
        }

        if (providerForm) {
          providerForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const providerData = {
              name: document.getElementById("provider-name").value,
              service_type: document.getElementById("provider-service").value,
              phone: document.getElementById("provider-phone").value,
              email: document.getElementById("provider-email").value,
              address: document.getElementById("provider-address")?.value || "",
              experience_years: parseInt(
                document.getElementById("provider-experience")?.value || "0"
              ),
              hourly_rate: parseFloat(
                document.getElementById("provider-rate")?.value || "0"
              ),
              rating: parseFloat(
                document.getElementById("provider-rating")?.value || "0"
              ),
              total_bookings: parseInt(
                document.getElementById("provider-bookings")?.value || "0"
              ),
              status:
                document.getElementById("provider-status")?.value || "active",
            };

            const result = await addProvider(providerData);
            if (result) {
              // Close the modal
              providerModal.style.display = "none";

              // Reset the form
              providerForm.reset();
            }
          });
        }

        // Provider details modal event listeners
        if (closeProviderDetailsModal) {
          closeProviderDetailsModal.addEventListener("click", function () {
            providerDetailsModal.style.display = "none";
          });
        }

        if (closeProviderDetails) {
          closeProviderDetails.addEventListener("click", function () {
            providerDetailsModal.style.display = "none";
          });
        }

        if (editProviderBtn) {
          editProviderBtn.addEventListener("click", function () {
            const providerId = parseInt(this.getAttribute("data-provider-id"));
            providerDetailsModal.style.display = "none";
            editProvider(providerId);
          });
        }

        // Provider edit modal event listeners
        if (closeProviderEditModal) {
          closeProviderEditModal.addEventListener("click", function () {
            providerEditModal.style.display = "none";
          });
        }

        if (cancelProviderEdit) {
          cancelProviderEdit.addEventListener("click", function () {
            providerEditModal.style.display = "none";
          });
        }

        if (providerEditForm) {
          providerEditForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const providerId = parseInt(this.getAttribute("data-provider-id"));

            const updatedProvider = {
              name: document.getElementById("edit-provider-name").value,
              service_type: document.getElementById("edit-provider-service")
                .value,
              phone: document.getElementById("edit-provider-phone").value,
              email: document.getElementById("edit-provider-email").value,
              address: document.getElementById("edit-provider-address").value,
              experience_years: parseInt(
                document.getElementById("edit-provider-experience").value
              ),
              hourly_rate: parseFloat(
                document.getElementById("edit-provider-rate").value
              ),
              rating: parseFloat(
                document.getElementById("edit-provider-rating").value
              ),
              total_bookings: parseInt(
                document.getElementById("edit-provider-bookings").value
              ),
              status: document.getElementById("edit-provider-status").value,
            };

            try {
              const response = await fetch(
                `${API_BASE_URL}/api/providers/${providerId}`,
                {
                  method: "PATCH",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(updatedProvider),
                }
              );

              if (response.ok) {
                providerEditModal.style.display = "none";
                alert("Provider updated successfully!");
                loadProviders();
              } else {
                const errorData = await response.json();
                alert(
                  `Failed to update provider: ${
                    errorData.error || "Unknown error"
                  }`
                );
              }
            } catch (error) {
              console.error("[ERROR] Failed to update provider:", error);
              alert("Failed to update provider. Please try again.");
            }
          });
        }

        // Close modals when clicking outside
        if (providerModal) {
          providerModal.addEventListener("click", function (e) {
            if (e.target === this) {
              this.style.display = "none";
            }
          });
        }

        if (providerDetailsModal) {
          providerDetailsModal.addEventListener("click", function (e) {
            if (e.target === this) {
              this.style.display = "none";
            }
          });
        }

        if (providerEditModal) {
          providerEditModal.addEventListener("click", function (e) {
            if (e.target === this) {
              this.style.display = "none";
            }
          });
        }
      });

      window.confirmBooking = async function (event, id) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        await fetch(`${API_BASE_URL}/api/bookings/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: "confirmed" }),
        });
        loadDashboard();
        loadAllBookings();
        // Stay on bookings section
        localStorage.setItem("adminActiveSection", "bookings-section");
        showActiveAdminSection();
      };
      window.deleteBooking = async function (event, id) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        await fetch(`${API_BASE_URL}/api/bookings/${id}`, {
          method: "DELETE",
        });
        loadDashboard();
        loadAllBookings();
        // Stay on bookings section
        localStorage.setItem("adminActiveSection", "bookings-section");
        showActiveAdminSection();
      };

      // Service Requests Management Functions
      async function loadServiceRequests() {
        const status = document.getElementById('request-status-filter')?.value || '';
        const search = document.getElementById('request-search-input')?.value || '';
        
        let url = `${API_BASE_URL}/api/service-requests`;
        const params = [];
        if (status) params.push(`status=${status}`);
        if (search) params.push(`search=${encodeURIComponent(search)}`);
        if (params.length) url += '?' + params.join('&');
        
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to fetch service requests');
          const requests = await response.json();
          displayServiceRequests(requests);
        } catch (error) {
          console.error('[ERROR] Failed to load service requests:', error);
          const tbody = document.getElementById('service-requests-table-body');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #ef4444;">Error loading service requests. Please try again.</td></tr>';
          }
        }
      }

      function displayServiceRequests(requests) {
        const tbody = document.getElementById('service-requests-table-body');
        if (!tbody) return;
        
        if (requests.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #6b7280;">No service requests found</td></tr>';
          return;
        }
        
        tbody.innerHTML = requests.map(req => {
          const items = typeof req.selected_items === 'string' ? JSON.parse(req.selected_items) : req.selected_items;
          const firstCategory = items && items.length > 0 ? items[0].category : 'N/A';
          
          return `
            <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor=''">
              <td style="padding: 1rem; font-weight: 600; color: #3b82f6;">#${req.request_id}</td>
              <td style="padding: 1rem;">${req.customer_name || 'N/A'}</td>
              <td style="padding: 1rem;">${firstCategory}</td>
              <td style="padding: 1rem;">${req.preferred_date || 'N/A'}</td>
              <td style="padding: 1rem;">
                <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; ${getServiceRequestStatusClass(req.status)}">
                  ${req.status || 'pending'}
                </span>
              </td>
              <td style="padding: 1rem; font-weight: 600;">R${(req.total_customer_paid || 0).toFixed(2)}</td>
              <td style="padding: 1rem;">R${(req.total_provider_payout || 0).toFixed(2)}</td>
              <td style="padding: 1rem; color: #22c55e; font-weight: 600;">R${(req.total_commission_earned || 0).toFixed(2)}</td>
              <td style="padding: 1rem;">
                <button onclick="viewServiceRequestDetail(${req.request_id})" style="background: #3b82f6; color: #fff; border: none; padding: 0.4rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500;">View</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      function getServiceRequestStatusClass(status) {
        const classes = {
          pending: 'background: #fef3c7; color: #92400e;',
          confirmed: 'background: #dbeafe; color: #1e40af;',
          in_progress: 'background: #e9d5ff; color: #6b21a8;',
          completed: 'background: #d1fae5; color: #065f46;',
          cancelled: 'background: #fee2e2; color: #991b1b;'
        };
        return classes[status] || 'background: #f3f4f6; color: #374151;';
      }

      async function viewServiceRequestDetail(requestId) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/service-requests/${requestId}`);
          if (!response.ok) throw new Error('Failed to fetch request details');
          const request = await response.json();
          
          const items = typeof request.selected_items === 'string' ? JSON.parse(request.selected_items) : request.selected_items;
          const itemsHtml = items && items.length > 0 ? items.map(item => `
            <tr>
              <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${item.type || 'N/A'}${item.is_white ? ' (White)' : ''}</td>
              <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${item.quantity || 1}</td>
              <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">R${(item.customer_price || 0).toFixed(2)}</td>
              <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">R${(item.provider_price || 0).toFixed(2)}</td>
              <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">R${(item.commission || 0).toFixed(2)}</td>
            </tr>
          `).join('') : '<tr><td colspan="5" style="text-align: center; padding: 1rem;">No items found</td></tr>';
          
          document.getElementById('service-request-detail-content').innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
              <div>
                <h3 style="font-weight: 700; margin-bottom: 1rem; color: #111;">Request ID: #${request.request_id}</h3>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                  <select id="detail-request-status" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; flex: 1; min-width: 150px;">
                    <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="confirmed" ${request.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                    <option value="in_progress" ${request.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                    <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                    <option value="cancelled" ${request.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  </select>
                  <select id="detail-request-priority" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; flex: 1; min-width: 150px;">
                    <option value="low" ${request.priority === 'low' ? 'selected' : ''}>Low Priority</option>
                    <option value="medium" ${request.priority === 'medium' ? 'selected' : ''}>Medium Priority</option>
                    <option value="high" ${request.priority === 'high' ? 'selected' : ''}>High Priority</option>
                  </select>
                </div>
              </div>
              
              <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: #111;">Customer Information</h4>
                <p style="margin: 0.25rem 0;">Name: ${request.customer_name || 'N/A'}</p>
                <p style="margin: 0.25rem 0;">Phone: <a href="tel:${request.customer_phone}" style="color: #3b82f6; text-decoration: none;">${request.customer_phone || 'N/A'}</a></p>
                <p style="margin: 0.25rem 0;">Email: <a href="mailto:${request.customer_email}" style="color: #3b82f6; text-decoration: none;">${request.customer_email || 'N/A'}</a></p>
                <p style="margin: 0.25rem 0;">Address: ${request.customer_address || 'N/A'}</p>
                ${request.unit_number ? `<p style="margin: 0.25rem 0;">Unit: ${request.unit_number}</p>` : ''}
                ${request.complex_name ? `<p style="margin: 0.25rem 0;">Complex: ${request.complex_name}</p>` : ''}
              </div>
              
              <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: #111;">Schedule</h4>
                <p style="margin: 0.25rem 0;">Date: ${request.preferred_date || 'N/A'}</p>
                <p style="margin: 0.25rem 0;">Time: ${request.preferred_time || 'N/A'}</p>
              </div>
              
              <div>
                <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: #111;">Services Requested</h4>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <thead style="background: #f3f4f6;">
                      <tr>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb;">Item</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb;">Quantity</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb;">Customer Pays</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb;">Provider Gets</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb;">Commission</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${itemsHtml}
                      <tr style="background: #fff3cd; font-weight: 500;">
                        <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;" colspan="2">Callout Fee</td>
                        <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;">R100.00</td>
                        <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;">-</td>
                        <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;">R100.00</td>
                      </tr>
                      <tr style="background: #f8fafc; font-weight: 600;">
                        <td style="padding: 0.75rem; border-top: 2px solid #e5e7eb;" colspan="2">TOTALS</td>
                        <td style="padding: 0.75rem; border-top: 2px solid #e5e7eb;">R${(request.total_customer_paid || 0).toFixed(2)}</td>
                        <td style="padding: 0.75rem; border-top: 2px solid #e5e7eb;">R${(request.total_provider_payout || 0).toFixed(2)}</td>
                        <td style="padding: 0.75rem; border-top: 2px solid #e5e7eb; color: #22c55e;">R${(request.total_commission_earned || 0).toFixed(2)}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: #111;">Provider Assignment</h4>
                <select id="detail-request-provider" style="width: 100%; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 0.5rem;">
                  <option value="">Select Provider</option>
                </select>
                ${request.provider_name ? `<p style="margin: 0.25rem 0;">Currently Assigned: <strong>${request.provider_name}</strong> (${request.provider_phone || 'N/A'})</p>` : '<p style="color: #6b7280;">No provider assigned</p>'}
              </div>
              
              ${request.additional_notes ? `
              <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: #111;">Additional Notes</h4>
                <p style="color: #374151;">${request.additional_notes}</p>
              </div>
              ` : ''}
              
              <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button onclick="saveServiceRequestDetail(${request.request_id})" style="background: #3b82f6; color: #fff; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1;">Save Changes</button>
                <button onclick="closeServiceRequestDetail()" style="background: #e5e7eb; color: #374151; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1;">Close</button>
              </div>
            </div>
          `;
          
          // Load providers for dropdown
          await loadProvidersForRequestSelect();
          
          document.getElementById('service-request-detail-modal').style.display = 'flex';
        } catch (error) {
          console.error('[ERROR] Failed to load request detail:', error);
          alert('Failed to load request details. Please try again.');
        }
      }

      async function loadProvidersForRequestSelect() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/providers`);
          if (!response.ok) throw new Error('Failed to fetch providers');
          const providers = await response.json();
          const select = document.getElementById('detail-request-provider');
          if (!select) return;
          
          select.innerHTML = '<option value="">Select Provider</option>';
          providers.forEach(provider => {
            const option = document.createElement('option');
            option.value = provider.id;
            option.textContent = `${provider.name} - ${provider.phone}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('[ERROR] Failed to load providers:', error);
        }
      }

      async function saveServiceRequestDetail(requestId) {
        const status = document.getElementById('detail-request-status')?.value;
        const priority = document.getElementById('detail-request-priority')?.value;
        const providerId = document.getElementById('detail-request-provider')?.value;
        
        try {
          const updateData = {};
          if (status) updateData.status = status;
          if (priority) updateData.priority = priority;
          
          if (providerId) {
            updateData.assigned_provider_id = parseInt(providerId);
            const providerResponse = await fetch(`${API_BASE_URL}/api/providers/${providerId}`);
            if (providerResponse.ok) {
              const provider = await providerResponse.json();
              updateData.provider_name = provider.name;
              updateData.provider_phone = provider.phone;
              updateData.provider_email = provider.email;
            }
          }
          
          const response = await fetch(`${API_BASE_URL}/api/service-requests/${requestId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
          });
          
          if (response.ok) {
            alert('Request updated successfully');
            closeServiceRequestDetail();
            loadServiceRequests();
            // Also refresh dashboard if on dashboard
            if (document.getElementById('dashboard-section').style.display !== 'none') {
              loadDashboard();
            }
          } else {
            const errorData = await response.json();
            alert(`Failed to update request: ${errorData.error || 'Unknown error'}`);
          }
        } catch (error) {
          console.error('[ERROR] Failed to update request:', error);
          alert('Failed to update request. Please try again.');
        }
      }

      function closeServiceRequestDetail() {
        document.getElementById('service-request-detail-modal').style.display = 'none';
      }

      // Financial Reports Functions
      async function loadFinancialReport() {
        const from = document.getElementById('financial-report-from')?.value || '';
        const to = document.getElementById('financial-report-to')?.value || '';
        
        let url = `${API_BASE_URL}/api/admin/financial-report`;
        const params = [];
        if (from) params.push(`from=${from}`);
        if (to) params.push(`to=${to}`);
        if (params.length) url += '?' + params.join('&');
        
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to fetch financial report');
          const report = await response.json();
          displayFinancialReport(report);
        } catch (error) {
          console.error('[ERROR] Failed to load financial report:', error);
          const content = document.getElementById('financial-report-content');
          if (content) {
            content.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading financial report. Please try again.</p>';
          }
        }
      }

      function displayFinancialReport(report) {
        const content = document.getElementById('financial-report-content');
        if (!content) return;
        
        const categoryBreakdown = report.category_breakdown ? Object.entries(report.category_breakdown).map(([cat, data]) => `
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 0.75rem;">${cat}</td>
            <td style="padding: 0.75rem;">${data.count || 0}</td>
            <td style="padding: 0.75rem; color: #22c55e; font-weight: 600;">R${(data.commission || 0).toFixed(2)}</td>
          </tr>
        `).join('') : '<tr><td colspan="3" style="text-align: center; padding: 1rem; color: #6b7280;">No category data available</td></tr>';
        
        content.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 2rem;">
            <div>
              <h3 style="font-weight: 700; margin-bottom: 1rem; color: #111; font-size: 1.3rem;">Summary</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                  <p style="color: #6b7280; margin-bottom: 0.5rem; font-size: 0.9rem;">Total Customer Payments</p>
                  <p style="font-size: 1.8rem; font-weight: 700; color: #111;">R${(report.total_customer_payments || 0).toFixed(2)}</p>
                </div>
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                  <p style="color: #6b7280; margin-bottom: 0.5rem; font-size: 0.9rem;">Total Provider Payouts</p>
                  <p style="font-size: 1.8rem; font-weight: 700; color: #111;">R${(report.total_provider_payouts || 0).toFixed(2)}</p>
                </div>
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                  <p style="color: #6b7280; margin-bottom: 0.5rem; font-size: 0.9rem;">Total Commission Earned</p>
                  <p style="font-size: 1.8rem; font-weight: 700; color: #22c55e;">R${(report.total_commission || 0).toFixed(2)}</p>
                </div>
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                  <p style="color: #6b7280; margin-bottom: 0.5rem; font-size: 0.9rem;">Average Commission per Job</p>
                  <p style="font-size: 1.8rem; font-weight: 700; color: #111;">R${(report.avg_commission || 0).toFixed(2)}</p>
                </div>
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                  <p style="color: #6b7280; margin-bottom: 0.5rem; font-size: 0.9rem;">Number of Jobs</p>
                  <p style="font-size: 1.8rem; font-weight: 700; color: #111;">${report.number_of_jobs || 0}</p>
                </div>
              </div>
            </div>
            
            <div>
              <h3 style="font-weight: 700; margin-bottom: 1rem; color: #111; font-size: 1.3rem;">Breakdown by Service Category</h3>
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                  <thead style="background: #f3f4f6;">
                    <tr>
                      <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Category</th>
                      <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Jobs</th>
                      <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Commission</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${categoryBreakdown}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }

      function exportFinancialReport() {
        alert('CSV export functionality will be implemented here. This would generate a downloadable CSV file with the financial report data.');
      }

      // Event listeners for service requests
      document.addEventListener('DOMContentLoaded', function() {
        const requestStatusFilter = document.getElementById('request-status-filter');
        const requestSearchInput = document.getElementById('request-search-input');
        
        if (requestStatusFilter) {
          requestStatusFilter.addEventListener('change', loadServiceRequests);
        }
        
        if (requestSearchInput) {
          let searchTimeout;
          requestSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(loadServiceRequests, 500);
          });
        }
      });

      // Update loadDashboard to use service requests API
      async function loadServiceRequestsDashboard() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/admin/stats`);
          if (response.ok) {
            const stats = await response.json();
            // Update dashboard widgets if they exist
            const totalBookingsEl = document.getElementById('total-bookings');
            if (totalBookingsEl) totalBookingsEl.textContent = stats.total_bookings || 0;
            
            const totalEarningsEl = document.getElementById('total-earnings');
            if (totalEarningsEl) {
              const revenue = stats.this_month_revenue || 0;
              totalEarningsEl.textContent = `R${revenue.toFixed(2)}`;
            }
          }
        } catch (error) {
          console.error('[ERROR] Failed to load dashboard stats:', error);
        }
      }

      // Dark mode functionality
      document.addEventListener("DOMContentLoaded", () => {
        const toggleBtn = document.getElementById("toggle-dark");
        const html = document.documentElement;

        if (toggleBtn) {
          // Check for saved theme preference or default to light mode
          const savedTheme = localStorage.getItem("theme") || "light";
          if (savedTheme === "dark") {
            html.classList.add("dark");
            toggleBtn.textContent = "🌙";
          } else {
            html.classList.remove("dark");
            toggleBtn.textContent = "☀️";
          }

          toggleBtn.addEventListener("click", () => {
            html.classList.toggle("dark");
            const isDark = html.classList.contains("dark");
            toggleBtn.textContent = isDark ? "🌙" : "☀️";
            localStorage.setItem("theme", isDark ? "dark" : "light");
          });
        }
      });
    </script>
    <script src="/js/config.js"></script>
    <script src="/js/script.js"></script>
  </body>
</html>
